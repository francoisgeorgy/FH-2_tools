<!DOCTYPE html>
<head>
<title>FH-2 Configuration Tool</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Mono">
<style>

html {
    color-scheme: light;
    --tr-a-bg: #e0e0e0;
    --th-bg: #c0c0c0;
    --td-tc-bg: #c0c0c0;
    --td-tc-a-bg: #e0e0e0;
    --bg-blue: #c4d0ff;
    --main-bg-color: #ffffff;
    --link: blue;
    --link-hover: #000;
    --link-active: #000;
    --text-primary: #000;
    --text-secondary: rgba(0, 0, 0, 0.87);
    --text-disabled: rgba(0, 0, 0, 0.38);
    --text-light: rgba(0, 0, 0, 0.33);
    --header-bg: rgba(0, 0, 0, 0.1);
    --border-light: #ddd;
    --border-colored: #afafb7;
    --load-button-bg: #ffff00;
    --load-button-bg-hover: #efef00;
    --load-button-text: #000;
}

html[data-theme='dark'] {
    color-scheme: dark;
    --tr-a-bg: #000;
    --th-bg: #333;
    --td-tc-bg: #333;
    --td-tc-a-bg: #555;
    --bg-blue: #051e7a;
    --main-bg-color: #1d1d1f;
    --link: #bdb0ff;
    --link-hover: #ffffff;
    --link-active: #ffffff;
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.75);
    --text-disabled: rgba(255, 255, 255, 0.66);
    --text-light: rgba(255, 255, 255, 0.33);
    --header-bg: #000000;
    --load-button-bg: #999e4b;
    --load-button-bg-hover: #8a8d43;
    --load-button-text: #000;
}

html[data-theme='dark'] input,
html[data-theme='dark'] select,
html[data-theme='dark'] textarea {
    border-color: transparent;
}

body {
    background-color: var(--main-bg-color);
    color: var(--text-secondary)
}
a {
    text-decoration: none;
}
button {
}
select {
}
tr.a {
	background-color: var(--tr-a-bg);
}
th {
	background-color: var(--th-bg);
	font-size: 80%;
}
td.tc {
	text-align: center;
	background-color: var(--td-tc-bg);
	font-size: 80%;
}
td.tc_a {
	text-align: center;
	background-color: var(--td-tc-a-bg);
	font-size: 80%;
}
input {
}
textarea {
    font-family: 'PT Mono', monospace;
	font-size: 11px;
}
body {
	font-family: 'PT Sans', serif;
	font-size: 16px;
    margin-bottom: 1rem;
}
button.big {
	font-size: 120%;
}
input, select, button {
    font-family: 'PT Sans', serif;
    font-size: 11px;
}
div.small {
	font-size: 80%;
}
table {
	margin-bottom: 5px;
}
div.tc_c {
	font-size: 80%;
}
td.number {
    text-align: right;
}
.bg-blue {
    background-color: var(--bg-blue);
}
div.rth {
	-webkit-writing-mode: vertical-rl;
	transform: rotate(200deg);
	padding-left: 5px;
	padding-right: 5px;
}
textarea {
    font-family: 'PT Mono', monospace;
	font-size: 11px;
}
table.logs {
	margin: 0px;
	border-spacing: 0px;
}
td.logs {
	padding: 0px;
}
label.logs {
	font-size: 80%;
}
.hidden {
	position:absolute;
	left:-10000px;
	top:auto;
	width:1px;
	height:1px;
	overflow:hidden;
}
p {
	margin-block-start: 0em;
	margin-block-end: 0em;
}
div.relative_cb {
	display:inline;
}
input.relative_cb {
	margin:0px;
}

.small {
    font-size: 80%;
}
.large {
    font-size: large;
}
.x-large {
    font-size: larger;
}
.margin-y {
    margin-top: 6px;
    margin-bottom: 6px;
}
.margin-left {
    margin-left: 1rem;
}

table.show td {
    padding-right: 10px;
}

/* * { user-select: none; }*/
label { user-select: none; }
/*input { user-select: auto; }*/

th.lfo,
td.lfo {
    display: none;
}

table {
    margin-right: 1rem;
}

/* output range: */
.range-0 { background-color: white; color: black; }         /* 0-10 */
.range-1 { background-color: #7878ff; color: white; }       /* +-5 */
.range-2 { background-color: #b3c0fd; color: black; }       /* 1 */
.range-3 { background-color: lightgreen; color: black; }    /* 5 */
.range-4 { background-color: yellow; color: black; }        /* 8 */

</style>
<script>

    // start in dark mode :
    document.documentElement.setAttribute('data-theme', 'dark');

function noop() {}
console.log = noop;
console.warn = noop;

const wait = ms => new Promise(r => setTimeout(r, ms));

const themeKey = 'fh2-custom-theme';

function changeTheme(t) {
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem(themeKey, t);
    return false;
}


console.log("building html...");

/* SYSEX */
function log( t, color = null ) {
	var ta = document.getElementById( "log" );
	var d = new Date();
	var dd = d.toLocaleTimeString();
	// ta.value = ta.value + "\n" + dd + ": " + t;
    ta.value = `${ta.value}\n${dd}: ${t}`;
	ta.scrollTop = ta.scrollHeight;
    // return timestamp
	return dd;
}

function getOptionsHTML(start, end, valueOffset, displayOffset=0, selected=-1) {
    let s = '';
    for (let i = start; i <= end; ++i) {
        s += `<option value='${i + valueOffset}' ${i === selected ? 'selected' : ''}>${i + displayOffset}</option>`;
    }
    return s;
}

function status( t ) {
    document.getElementById( "status" ).innerHTML = "Web MIDI status: " + t;
}
function nybbleChar( n ) {
	if ( n >= 10 ) {
		return String.fromCharCode( 'A'.charCodeAt( 0 ) + n - 10 );
	}
	return String.fromCharCode( '0'.charCodeAt( 0 ) + n );
}
function makeSysExMcv( data, c, m ) {
	// enable
	data[c] = document.getElementById( "mcv_enable_" + m ).checked;	c += 1;
	// channel
	data[c] = document.getElementById( "mcv_ch_" + m ).value - 1;	c += 1;
	// min/max
	data[c] = document.getElementById( "mcv_min_" + m ).value; c += 1;
	data[c] = document.getElementById( "mcv_max_" + m ).value; c += 1;
	// type
	data[c] = document.getElementById( "mcv_type_" + m ).value; c += 1;
	// polyphony
	data[c] = document.getElementById( "mcv_voices_" + m ).value; c += 1;
	// bend depth
	data[c] = document.getElementById( "mcv_bend_" + m ).value;	c += 1;
	// voice allocation scheme
	data[c] = document.getElementById( "mcv_scheme_" + m ).value; c += 1;
	// ignore surplus
	data[c] = document.getElementById( "mcv_stealing_" + m ).checked;	c += 1;
	// gated pressure
	data[c] = document.getElementById( "mcv_GA_" + m ).checked;	c += 1;
	// sustain
	data[c] = document.getElementById( "mcv_SUS_" + m ).value;	c += 1;
	// base output
	data[c] = document.getElementById( "mcv_base_" + m ).value; c += 1;
	// stride
	data[c] = document.getElementById( "mcv_stride_" + m ).value; c += 1;
	// last MPE
	data[c] = document.getElementById( "mcv_lastMPE_" + m ).value - 1; c += 1;
	// pressure
	data[c] = document.getElementById( "mcv_A_" + m ).checked;	c += 1;
	// para gate
	data[c] = document.getElementById( "mcv_G_" + m ).checked;	c += 1;
	// cv output
	data[c] = document.getElementById( "mcv_VC_" + m ).checked;	c += 1;
	// gate output
	data[c] = document.getElementById( "mcv_VG_" + m ).checked;	c += 1;
	// vel gate output
	data[c] = document.getElementById( "mcv_VVG_" + m ).checked;	c += 1;
	// vel output
	data[c] = document.getElementById( "mcv_VV_" + m ).value;	c += 1;
	// rel vel output
	data[c] = document.getElementById( "mcv_VR_" + m ).value;	c += 1;
	// trigger output
	data[c] = document.getElementById( "mcv_VT_" + m ).checked;	c += 1;
	// voice pressure output
	data[c] = document.getElementById( "mcv_VP_" + m ).checked;	c += 1;
	// MPE Y output/CC
	data[c] = document.getElementById( "mcv_VY_" + m ).value;	c += 1;
	// envelope output
	data[c] = document.getElementById( "mcv_VE_" + m ).checked;	c += 1;
	// base gate output
	data[c] = document.getElementById( "mcv_basegate_" + m ).value; c += 1;
	// mono retrigger
	data[c] = document.getElementById( "mcv_MT_" + m ).checked;	c += 1;
	// interrupt gate
	data[c] = document.getElementById( "mcv_IG_" + m ).checked;	c += 1;
	// env zero start
	data[c] = document.getElementById( "mcv_ZS_" + m ).checked;	c += 1;
	// bend down depth
	data[c] = document.getElementById( "mcv_benddown_" + m ).value;	c += 1;
	// pitch bend output
	data[c] = document.getElementById( "mcv_PB_" + m ).value;	c += 1;
	// random output
	data[c] = document.getElementById( "mcv_VRND_" + m ).checked;	c += 1;

	return data;
}
function makeSysExMappings( data, c ) {
	var map = 0;

	for ( j=0; j<ac.length; ++j ) {
		for ( i = 0; i < 64; ++i ) {
			var ch = document.getElementById( "out_" + ac[j] + "_ch_" + i ).value - 1;
			var cc = document.getElementById( "out_" + ac[j] + "_cc_" + i ).value;
			let re = document.getElementById( "out_" + ac[j] + "_cc_" + i + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = acc[j] + re;
			data[c+3] = i + aco[j];
			c += 4;
			
			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
	}
	
	for ( j=1; j<17; ++j ) {
		var id = "arpeg" + j + "_";
		for ( i = 0; i < arpControls.length; ++i ) {
			var ch = document.getElementById( id + arpControls[i] + "_ch" ).value - 1;
			var cc = document.getElementById( id + arpControls[i] + "_cc" ).value;
			let re = document.getElementById( id + arpControls[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 9 + re;
			data[c+3] = (j-1)*8 + i;
			c += 4;
			
			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
		var id = "mcvcom" + j + "_";
		for ( i = 0; i < mcvCommands.length; ++i ) {
			var ch = document.getElementById( id + mcvCommands[i] + "_ch" ).value - 1;
			var cc = document.getElementById( id + mcvCommands[i] + "_cc" ).value;
			let re = document.getElementById( id + mcvCommands[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 11 + re;
			data[c+3] = (j-1)*8 + i;
			c += 4;
			
			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
		var id = "mcvm2_" + j + "_";
		for ( i = 0; i < mcvMappable2Controls.length; ++i ) {
			var ch = document.getElementById( id + mcvMappable2Controls[i] + "_ch" ).value - 1;
			var cc = document.getElementById( id + mcvMappable2Controls[i] + "_cc" ).value;
			let re = document.getElementById( id + mcvMappable2Controls[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 12 + re;
			data[c+3] = (j-1)*8 + i;
			c += 4;
			
			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
	}

	for ( j=1; j<17; ++j ) {
		var id = "euc_" + j + "_";
		for ( i = 0; i < eucControls.length; ++i ) {
			var ch = document.getElementById( id + eucControls[i] + "_ch" ).value - 1;
			var cc = document.getElementById( id + eucControls[i] + "_cc" ).value;
			let re = document.getElementById( id + eucControls[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 10 + re;
			data[c+3] = (j-1)*8 + i;
			c += 4;

			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
	}

	for ( j=1; j<17; ++j ) {
		var id = "srr_" + j + "_";
		for ( i = 0; i < srrControls.length; ++i ) {
			var ch = document.getElementById( id + srrControls[i] + "_ch" ).value - 1;
			var cc = document.getElementById( id + srrControls[i] + "_cc" ).value;
			let re = document.getElementById( id + srrControls[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 15 + re;
			data[c+3] = (j-1)*8 + i;
			c += 4;

			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
	}

	for ( j=0; j<4; ++j ) {
		let id = "seq" + j + "_";
		for ( i = 0; i < seqControls.length; ++i ) {
			let ch = document.getElementById( id + seqControls[i] + "_ch" ).value - 1;
			let cc = document.getElementById( id + seqControls[i] + "_cc" ).value;
			let re = document.getElementById( id + seqControls[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 13 + re;
			data[c+3] = j*16 + i;
			c += 4;

			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
	}
	for ( j=0; j<1; ++j ) {
		let id = "dseq" + j + "_";
		for ( i = 0; i < dseqControls.length; ++i ) {
			let ch = document.getElementById( id + dseqControls[i] + "_ch" ).value - 1;
			let cc = document.getElementById( id + dseqControls[i] + "_cc" ).value;
			let re = document.getElementById( id + dseqControls[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 13 + re;
			data[c+3] = (4+j)*16 + i;
			c += 4;

			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
	}
	for ( j=0; j<8; ++j ) {
		let id = "dseq0_" + j + "_";
		for ( i = 0; i < dseqlControls.length; ++i ) {
			let ch = document.getElementById( id + dseqlControls[i] + "_ch" ).value - 1;
			let cc = document.getElementById( id + dseqlControls[i] + "_cc" ).value;
			let re = document.getElementById( id + dseqlControls[i] + "_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch < 0 || cc < 0 ) {
				continue;
			}
			data[c+0] = 0x30 | ch;
			data[c+1] = cc;
			data[c+2] = 14 + re;
			data[c+3] = j*16 + i;
			c += 4;

			map += 1;
			if ( map >= 384 ) {
				return data;
			}
		}
	}

		{
			var ch = document.getElementById( "glb_tempo_ch" ).value - 1;
			var cc = document.getElementById( "glb_tempo_cc" ).value;
			let re = document.getElementById( "glb_tempo_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 69 + re;
				data[c+3] = 0;
				c += 4;
		
				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "dispmode_ch" ).value - 1;
			var cc = document.getElementById( "dispmode_cc" ).value;
			let re = document.getElementById( "dispmode_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 71 + re;
				data[c+3] = 0;
				c += 4;
		
				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "dispitem_ch" ).value - 1;
			var cc = document.getElementById( "dispitem_cc" ).value;
			let re = document.getElementById( "dispitem_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 72 + re;
				data[c+3] = 0;
				c += 4;
		
				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "glb_swing_type_ch" ).value - 1;
			var cc = document.getElementById( "glb_swing_type_cc" ).value;
			let re = document.getElementById( "glb_swing_type_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 74 + re;
				data[c+3] = 0;
				c += 4;
		
				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "glb_swing_amount_ch" ).value - 1;
			var cc = document.getElementById( "glb_swing_amount_cc" ).value;
			let re = document.getElementById( "glb_swing_amount_cc" + "_rel" ).checked ? 32 : 0;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 75 + re;
				data[c+3] = 0;
				c += 4;
		
				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "nudgefaster_ch" ).value - 1;
			var cc = document.getElementById( "nudgefaster_cc" ).value;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 76;
				data[c+3] = 0;
				c += 4;

				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "nudgeslower_ch" ).value - 1;
			var cc = document.getElementById( "nudgeslower_cc" ).value;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 77;
				data[c+3] = 0;
				c += 4;

				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "inctempo_ch" ).value - 1;
			var cc = document.getElementById( "inctempo_cc" ).value;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 78;
				data[c+3] = 0;
				c += 4;

				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}
		{
			var ch = document.getElementById( "dectempo_ch" ).value - 1;
			var cc = document.getElementById( "dectempo_cc" ).value;
			if ( ch >= 0 && cc >= 0 ) {
				data[c+0] = 0x30 | ch;
				data[c+1] = cc;
				data[c+2] = 79;
				data[c+3] = 0;
				c += 4;

				map += 1;
				if ( map >= 384 ) {
					return data;
				}
			}
		}

	log( map + " mapping(s)" );
	
	for ( ; map<384; ++map ) {
		data[c] = 0x7f;
		c += 4;
	}

	return data;
}
function makeSysExClocks( data, c, i ) {
	var clkid = "clk_" + i;
	data[c+0] = document.getElementById( clkid + "_type" ).value;
	data[c+1] = document.getElementById( clkid + "_base" ).value;
	data[c+2] = document.getElementById( clkid + "_mult" ).value;
	data[c+3] = document.getElementById( clkid + "_len" ).value;
	data[c+4] = document.getElementById( clkid + "_output" ).value;
	data[c+5] = document.getElementById( clkid + "_shift" ).value;
	return data;
}
function makeSysExTriggers( data, c, i ) {
	var clkid = "trg_" + i;
	var env = document.getElementById( clkid + "_env" ).value - 1;
	let note = document.getElementById( clkid + "_note" ).value;
	data[c+0] = document.getElementById( clkid + "_type" ).value | ( ( env >> 1 ) << 4 );
	data[c+1] = ( document.getElementById( clkid + "_ch" ).value - 1 ) | ( ( env & 1 ) << 4 ) | ( ( note < 0 ) << 5 );
	data[c+2] = note < 0 ? 0 : note;
	data[c+3] = document.getElementById( clkid + "_output" ).value;
	return data;
}
function sysexSafeShort( v ) {
	return ( v & 0x7f ) | ( ( v << 1 ) & 0x7f00 );
}
function unSysexSafeShort( v ) {
	return ( v & 0x7f ) | ( ( v >> 1 ) & 0x3f80 );
}
function unSysexSafeSignedShort( v ) {
	var s = ( v & 0x7f ) | ( ( v >> 1 ) & 0x3f80 );
	if ( s & 0x2000 ) {
		s = s - 16384;
	}
	return s;
}
function sysexSafeSignedChar( v ) {
	return v & 0x7f;
}
function unSysexSafeSignedChar( v ) {
	if ( v & 0x40 ) {
		return v - 128;
	}
	return v;
}
function makeSysEx() {
	var arr = new Uint8Array( 8192 );
	var d = [0xF0, 0x00, 0x21, 0x27, 0x2F, 0x10, 0x00, 0x00]
	var len = d.length
	for ( var i = 0; i < len; ++i ) {
		arr[i] = d[i];
	} 
	var c = len;
	// version
	arr[c] = 11;	 c += 1;
	arr[c] = 0;		 c += 1;
	arr[c] = 0;		 c += 1;
	arr[c] = 0;		 c += 1;
	// name
	var name = document.getElementById( "config_name" ).value;
	name += "                ";
	name = name.substring( 0, 16 );
	for ( var i = 0; i < 16; ++i ) {
		arr[c+i] = name.charCodeAt( i );
	}
	c += 17;
	// globals
	arr[c] = document.getElementById( "glb_triglen" ).value;		 c += 1;
	arr[c] = sysexSafeSignedChar( document.getElementById( "glb_transpose" ).value );		 c += 1;
	arr[c] = document.getElementById( "glb_legvel" ).checked;		 c += 1;
	arr[c] = document.getElementById( "glb_extclkmult" ).value;		 c += 1;
	arr[c] = document.getElementById( "glb_extclkrun" ).value;		 c += 1;
	arr[c] = document.getElementById( "glb_presetprogch" ).value;	 c += 1;
	arr[c] = document.getElementById( "glb_softtakeover" ).checked;	 c += 1;
	// output ranges
	for ( var i = 1; i < 65; ++i ) {
		arr[c] = document.getElementById( "rng_" + i ).value;		 c += 1;
	} 
	// mcvs
	for ( var i = 0; i < 16; ++i ) {
		arr = makeSysExMcv( arr, c, i+1 );
		c += 32;
	}
	// mappings
	arr = makeSysExMappings( arr, c );
	c += 384*4;
	// clocks
	for ( var i = 1; i < 33; ++i ) {
		arr = makeSysExClocks( arr, c, i );
		c += 8;
	}
	// gate levels
	for ( var i = 0; i < 64; ++i ) {
		var gtid = "out_gt_" + i;
		var v = document.getElementById( gtid + "_lo" ).value;
		v = sysexSafeShort( v );
		arr[c] = v & 0x7f;		 c += 1;
		arr[c] = v >> 8;		 c += 1;
		var v = document.getElementById( gtid + "_hi" ).value;
		v = sysexSafeShort( v );
		arr[c] = v & 0x7f;		 c += 1;
		arr[c] = v >> 8;		 c += 1;
	}
	// triggers
	for ( var i = 1; i <= 64; ++i ) {
		arr = makeSysExTriggers( arr, c, i );
		c += 4;
	}
	// euclidean outputs
	for ( var i = 1; i < 17; ++i ) {
		var v = document.getElementById( "euc_output_" + i ).value;
		arr[c] = v & 0x7f;	c += 1;
	}
	// globals
	arr[c] = document.getElementById( "glb_taptype" ).value;		 c += 1;
	arr[c] = document.getElementById( "glb_tapch" ).value;		 	c += 1;
	arr[c] = document.getElementById( "glb_tapcc" ).value;		 	c += 1;
	arr[c] = document.getElementById( "glb_eucaccent" ).value;		c += 1;
	arr[c] = document.getElementById( "glb_starttype" ).value;		 c += 1;
	arr[c] = document.getElementById( "glb_startch" ).value;		 c += 1;
	arr[c] = document.getElementById( "glb_startcc" ).value;		 c += 1;
	c += 1;
	// euclidean off outputs
	for ( var i = 1; i < 17; ++i ) {
		var v = document.getElementById( "euc_offoutput_" + i ).value;
		arr[c] = v & 0x7f;	c += 1;
	}
	// gamepad mappings
	for ( var i = 1; i < 33; ++i ) {
		var gtid = "hid_" + i;
		arr[c+0] = document.getElementById( gtid + "_usage" ).value;
		arr[c+1] = document.getElementById( gtid + "_output" ).value;
		var v = document.getElementById( gtid + "_scale" ).value;
		v = sysexSafeShort( v );
		arr[c+2] = v & 0x7f;
		arr[c+3] = v >> 8;
		var v = document.getElementById( gtid + "_offset" ).value;
		v = sysexSafeShort( v );
		arr[c+4] = v & 0x7f;
		arr[c+5] = v >> 8;
		c += 8;
	}
	// keyboard mappings
	for ( var i = 1; i < 33; ++i ) {
		var gtid = "kbd_" + i;
		arr[c+0] = document.getElementById( gtid + "_type" ).value;
		arr[c+1] = document.getElementById( gtid + "_output" ).value;
		arr[c+2] = document.getElementById( gtid + "_key" ).value;
		arr[c+3] = 0;
		var v = document.getElementById( gtid + "_value0" ).value;
		v = sysexSafeShort( v );
		arr[c+4] = v & 0x7f;
		arr[c+5] = v >> 8;
		var v = document.getElementById( gtid + "_value1" ).value;
		v = sysexSafeShort( v );
		arr[c+6] = v & 0x7f;
		arr[c+7] = v >> 8;
		c += 8;
	}
	// lfo resets
	for ( var i = 1; i < 65; ++i ) {
		var t = document.getElementById( "lfotrig_type_" + i ).value;
		var ch = document.getElementById( "lfotrig_ch_" + i ).value;
		arr[c+0] = ( t << 4 ) | ch;
		arr[c+1] = document.getElementById( "lfotrig_cc_" + i ).value;
		c += 2;
	}
	// cv/midi
	for ( var i = 0; i < 2; ++i ) {
		var en = document.getElementById( "cvm_en_" + i ).checked;
		var ti = document.getElementById( "cvm_outI_" + i ).checked;
		var ta = document.getElementById( "cvm_outA_" + i ).checked;
		var tc = document.getElementById( "cvm_outC_" + i ).checked;
		var td = document.getElementById( "cvm_outD_" + i ).checked;
		arr[c+0] = ( td << 4 ) | ( tc << 3 ) | ( ta << 2 ) | ( ti << 1 ) | en;
		arr[c+1] = ( document.getElementById( "cvm_type_" + i ).value << 4 ) | ( document.getElementById( "cvm_ch_" + i ).value - 1 );
		arr[c+2] = document.getElementById( "cvm_cc_" + i ).value;
		var v = document.getElementById( "cvm_0v_" + i ).value;
		v = sysexSafeShort( v );
		arr[c+4] = v & 0x7f;
		arr[c+5] = v >> 8;
		var v = document.getElementById( "cvm_5v_" + i ).value;
		v = sysexSafeShort( v );
		arr[c+6] = v & 0x7f;
		arr[c+7] = v >> 8;
		c += 8;
	}
	// globals
	arr[c] = document.getElementById( "glb_tempo_min" ).value;		 c += 1;
	arr[c] = document.getElementById( "glb_tempo_max" ).value;		 c += 1;
	c += 2;
	// sequencers
	for ( let i=0; i<4; ++i ) {
		arr[c] = document.getElementById( "seqn_" + i + "_ch" ).value - 1;	c += 1;
		let outs = 0;
		if ( document.getElementById( "seqn_" + i + "_int" ).checked )
			outs |= (1<<0);
		if ( document.getElementById( "seqn_" + i + "_c" ).checked )
			outs |= (1<<1);
		if ( document.getElementById( "seqn_" + i + "_a" ).checked )
			outs |= (1<<2);
		if ( document.getElementById( "seqn_" + i + "_d" ).checked )
			outs |= (1<<3);
    	arr[c] = outs;														c += 1;
		arr[c] = document.getElementById( "seqn_" + i + "_clk" ).value;		c += 1;
    	c += 1;
	}
	for ( let i=0; i<1; ++i ) {
		arr[c] = document.getElementById( "seqd_" + i + "_ch" ).value - 1;	c += 1;
		let outs = 0;
		if ( document.getElementById( "seqd_" + i + "_int" ).checked )
			outs |= (1<<0);
		if ( document.getElementById( "seqd_" + i + "_c" ).checked )
			outs |= (1<<1);
		if ( document.getElementById( "seqd_" + i + "_a" ).checked )
			outs |= (1<<2);
		if ( document.getElementById( "seqd_" + i + "_d" ).checked )
			outs |= (1<<3);
    	arr[c] = outs;														c += 1;
    	c += 2;
		for ( let j=0; j<8; ++j ) {
			arr[c] = document.getElementById( "seqd_" + i + "_n_" + j ).value;	c += 1;
		}
	}
	// midi/cv 2
	for ( let i=1; i<=16; ++i ) {
		arr[c] = document.getElementById( "arp_" + i + "_clk" ).value;	c += 1;
		let m = document.getElementById( "arp_out_" + i + "_ch" ).value - 1;
		if ( document.getElementById( "arp_out_" + i + "_c" ).checked )
			m |= (1<<4);
		if ( document.getElementById( "arp_out_" + i + "_a" ).checked )
			m |= (1<<5);
		if ( document.getElementById( "arp_out_" + i + "_d" ).checked )
			m |= (1<<6);
		arr[c] = m;		c += 1;
		c += 2;
	}
	// srr outputs
	for ( var i = 1; i < 17; ++i ) {
		arr[c] = document.getElementById( "srr_output_" + i ).value - (-1);
		c += 1;
		let v = document.getElementById( "srr_change_" + i ).value;
		arr[c] = v & 0x7f;	c += 1;
		v = document.getElementById( "srr_trigger_" + i ).value;
		arr[c] = v & 0x7f;	c += 1;
		arr[c] = document.getElementById( "srr_clk_" + i ).value;
		c += 1;
		v = document.getElementById( "srr_nch_" + i ).value;
		if ( v < 0 ) {
			v = 0;
		}
		arr[c] = v; 	c += 1;
		arr[c] = document.getElementById( "srr_ch_" + i ).value - 1;	c += 1;
		let outs = 0;
		if ( document.getElementById( "srr_int_" + i ).checked )
			outs |= (1<<0);
		if ( document.getElementById( "srr_c_" + i ).checked )
			outs |= (1<<1);
		if ( document.getElementById( "srr_a_" + i ).checked )
			outs |= (1<<2);
		if ( document.getElementById( "srr_d_" + i ).checked )
			outs |= (1<<3);
    	arr[c] = outs;														c += 1;
	}

	// pad to 4096 bytes
	while ( ( c - len ) < 4096 ) {
		arr[c] = 0;		 c += 1;
	}
	
	// addendum
	for ( var i = 1; i < 17; ++i ) {
		var v = document.getElementById( "euc_output_" + i ).value;
		arr[c] = ( v & 0x80 ) ? 1 : 0;	c += 1;
	}
	for ( var i = 1; i < 17; ++i ) {
		var v = document.getElementById( "euc_offoutput_" + i ).value;
		arr[c] = ( v & 0x80 ) ? 1 : 0;	c += 1;
	}
	for ( var i = 1; i < 17; ++i ) {
		let h = document.getElementById( "srr_change_" + i ).value;
		let t = document.getElementById( "srr_trigger_" + i ).value;
		arr[c] = ( ( h & 0x80 ) ? 1 : 0 ) | ( ( t & 0x80 ) ? 2 : 0 );
		c += 1;
	}

    arr[c] = 0xF7; c += 1;
	return arr.subarray( 0, c );

	// var str = ""
	// for ( var i = 0; i < c; ++i ) {
	// 	str += String.fromCharCode( arr[i] );
	// }
	// str += String.fromCharCode( 0xF7 );
	// return str;

}
function makeMsgSysEx() {
	var d = [0xF0, 0x00, 0x21, 0x27, 0x2F, 0x02]
	var len = d.length
	var str = ""
	for ( var i = 0; i < len; ++i ) {
		str += String.fromCharCode( d[i] );
	} 
	var text = "Hello!\nThis message\nwas sent from\nthe config tool.";
	str += text;
	str += String.fromCharCode( 0xF7 );
	return str;
}
function dumpSysex( data, id, prefix ) {
	var len = data.length
	var h = prefix
	for ( var i = 0; i < len; ++i ) {
		var b = data[ i ];
		h += nybbleChar( b >> 4 );
		h += nybbleChar( b & 0xf );
		h += " ";
		if ( ( i & 0xf ) === 0xf ) {
			h += "\n";
		}
	} 
	document.getElementById( id ).value = h;
}
</script>

<script>
var arpControls = [ "M", "R", "G", "L", "T", "P", "S", "E" ];
var arpControlsUI = [ "P", "E" ];
var arpControlsUI2 = [ "M", "R", "G", "L", "T", "S" ];
var seqControls = [ "T", "S", "G", "P" ];
var dseqControls = [ "S", "P" ];
var dseqlControls = [ "T", "S", "P" ];
var mcvMappable2Controls = [ "A", "D", "S", "R", "N", "P", "V", "RND" ];
var mcvCommands = [ "A", "R", "T", "N", "P", "K", "O" ];
var eucControls = [ "P", "S", "R", "T", "G", "A", "E" ];
var srrControls = [ "D", "L", "R", "T", "A", "S", "K", "G" ];
var menus = [ 'C', 'D', 'E' ];
var menuCCs = [ 80, 88, 96 ];
var unhandled = [];
var global_mappable = [ "glb_tempo", "dispmode", "dispitem", "glb_swing_type", "glb_swing_amount", "nudgefaster", "nudgeslower", "inctempo", "dectempo" ];
function hex( b ) {
	h = nybbleChar( b >> 4 );
	h += nybbleChar( b & 0xf );
	return h;
}
function changeClock( id ) {
	var v = document.getElementById( id + "_type" ).value;
	var s = ( v == 1 );
	document.getElementById( id + "_base" ).style.display = s ? "inline" : "none";
	document.getElementById( id + "_mult" ).style.display = s ? "inline" : "none";
	document.getElementById( id + "_len" ).style.display = s ? "inline" : "none";
	document.getElementById( id + "_shift" ).style.display = s ? "inline" : "none";
}
function changeTrigger( id ) {
	var v = document.getElementById( id + "_type" ).value;
	var s = ( v > 0 );
	document.getElementById( id + "_ch" ).style.display = s ? "inline" : "none";
	document.getElementById( id + "_note" ).style.display = s ? "inline" : "none";
	document.getElementById( id + "_env" ).style.display = ( v == 9 ) ? "inline" : "none";
}
function changeGateLevel( id ) {
	var v = document.getElementById( id ).value;
	var vi = Number( v );
	if ( !( vi >= 0 && vi < 16384 ) ) {
		document.getElementById( id ).value = 0;
	}
}
function changeCVMLevel( id ) {
	var v = document.getElementById( id ).value;
	var vi = Number( v );
	if ( !( vi > -16384 && vi < 16384 ) ) {
		document.getElementById( id ).value = 0;
	}
}
function changeHidUsage( id, i ) {
	var v = document.getElementById( id ).value;
	var s = ( v >= 20 && v <= 29 );
	document.getElementById( "hid_" + i + "_scale" ).style.display = s ? "inline" : "none";
	document.getElementById( "hid_" + i + "_offset" ).style.display = s ? "inline" : "none";
}
function changeHidScale( id ) {
	var v = document.getElementById( id ).value;
	var vi = Number( v );
	if ( !( vi >= -256 && vi <= 256 ) ) {
		document.getElementById( id ).value = 0;
	}
}
function changeHidOffset( id ) {
	var v = document.getElementById( id ).value;
	var vi = Number( v );
	if ( !( vi >= 0 && vi <= 4096 ) ) {
		document.getElementById( id ).value = 0;
	}
}
function changeStartStop() {
	var v = document.getElementById( 'glb_starttype' ).value;
	var s = ( v >= 1 ) && ( v <= 4 );
	document.getElementById( "glb_startch" ).style.display = s ? "inline" : "none";
	document.getElementById( "glb_startcc" ).style.display = s ? "inline" : "none";
}

function changeType( i ) {
	var ta = document.getElementById( "mcv_type_" + i );
	var m = false;
	var p = false;
	var mpe = false;
	switch ( ta.value ) {
		case "0":
			m = true;
			break;
		case "1":
			p = true;
			break;
		case "2":
			p = true;
			mpe = true;
			break;
	}
	var mp = m || p;
	var c = [ "G", "A" ];
	for ( k=0; k<2; ++k ) {
		id = "mcv_" + c[k] + "_" + i;
		ta = document.getElementById( id );
		ta.style.display = mp ? "inline" : "none";
	}
	var c = [ "mcv_scheme_", "mcv_stealing_", "mcv_voices_", "mcv_stride_" ];
	for ( k=0; k<c.length; ++k ) {
		id = c[k] + i;
		ta = document.getElementById( id );
		ta.style.display = p ? "inline" : "none";
	}
	var c = [ "mcv_lastMPE_", "mcv_VY_" ];
	for ( k=0; k<c.length; ++k ) {
		id = c[k] + i;
		ta = document.getElementById( id );
		ta.style.display = mpe ? "inline" : "none";
	}
	var c = [ "mcv_base_", "mcv_GA_" ];
	for ( k=0; k<c.length; ++k ) {
		id = c[k] + i;
		ta = document.getElementById( id );
		ta.style.display = mp ? "inline" : "none";
	}
	var c = [ "C", "G", "VG", "V", "R", "T" ];
	for ( k=0; k<6; ++k ) {
		id = "mcv_V" + c[k] + "_" + i;
		ta = document.getElementById( id );
		ta.style.display = mp ? "inline" : "none";
	}
	{
		id = "mcv_SUS_" + i;
		ta = document.getElementById( id );
		ta.style.display = mp ? "inline" : "none";
	}
	{
		id = "mcv_MT_" + i;
		ta = document.getElementById( id );
		ta.style.display = m ? "inline" : "none";
	}
}

function getChannelSelector( id, includeNone=true ) {
    let o = '';
    o += "<select id='" + id + "'>";
    if ( includeNone ) {
        o += "<option value='-1'>None</option>";
    }
    o += getOptionsHTML(0, 7, 0, 1);
    var e;
    for ( e = 1; e < 8; ++e ) {
        for ( j = 0; j < 8; ++j ) {
            o += "<option value='"+(e*8+j)+"'>" + e + "/" + (j+1) + "</option>";
        }
    }
    o += "</select>";
    return o;
}

function writeChannelSelector( id, includeNone=true ) {
    document.write(getChannelSelector(id, includeNone));
/*
	document.write( "<select id='" + id + "'>" );
	if ( includeNone ) {
		document.write( "<option value='-1'>None</option>" );
	}
    document.write(getOptionsString(0, 7, 0, 1));
	var e;
	for ( e = 1; e < 8; ++e ) {
		for ( j = 0; j < 8; ++j ) {
			document.write( "<option value='"+(e*8+j)+"'>" + e + "/" + (j+1) + "</option>" );
		}
	}
	document.write( "</select>" );
*/
}

function getGateChannelSelectorHTML( id, includeNone=true, value=-1 ) {
    let o = '';
	o += `<select id='${id}'>`;
	if ( includeNone ) {
		o += `<option value='-1' ${value === -1 ? 'selected' : ''}>None</option>`;
	}
	for ( j = 0; j < 8; ++j ) {
		o += `<option value='${j}' ${value === j ? 'selected' : ''}>${j+1}</option>`;
	}
	var e;
	for ( e = 1; e < 8; ++e ) {
		for ( j = 0; j < 8; ++j ) {
			o += `<option value='${e*8+j}' ${value === (e*8+j) ? 'selected' : ''}>${e}/${j+1}</option>`;
		}
	}
	for ( e = 0; e < 4; ++e ) {
		for ( j = 0; j < 16; ++j ) {
			o += `<option value='${64+e*16+j}' ${value === (64+e*16+j) ? 'selected' : ''}>GT${e}/${j+1}</option>`;
		}
	}
	// if ( includeNone ) {
	// 	o += "<option value='-1'>None</option>";
	// }
	// for ( j = 0; j < 8; ++j ) {
	// 	o += "<option value='"+j+"'>" + (j+1) + "</option>";
	// }
	// var e;
	// for ( e = 1; e < 8; ++e ) {
	// 	for ( j = 0; j < 8; ++j ) {
	// 		o += "<option value='"+(e*8+j)+"'>" + e + "/" + (j+1) + "</option>";
	// 	}
	// }
	// for ( e = 0; e < 4; ++e ) {
	// 	for ( j = 0; j < 16; ++j ) {
	// 		o += "<option value='"+(64+e*16+j)+"'>GT" + e + "/" + (j+1) + "</option>";
	// 	}
	// }
	o += "</select>";
    return o;
}

function writeGateChannelSelector( id, includeNone=true ) {
    document.write(getGateChannelSelectorHTML(id, includeNone));
}

function getBaseGateChannelSelectorHTML( id ) {
    let o = '';
    o += "<select id='" + id + "'>";
    if ( 1 ) {
        o += "<option value='0'>--</option>";
    }
    var e;
    for ( e = 0; e < 4; ++e ) {
        for ( j = 0; j < 16; ++j ) {
            o += "<option value='"+(64+e*16+j)+"'>" + e + "/" + (j+1) + "</option>";
        }
    }
    o += "</select>";
    return o;
}

function writeBaseGateChannelSelector( id ) {
    // let o = '';
	// o += "<select id='" + id + "'>";
	// if ( 1 ) {
	// 	o += "<option value='0'>--</option>";
	// }
	// var e;
	// for ( e = 0; e < 4; ++e ) {
	// 	for ( j = 0; j < 16; ++j ) {
	// 		o += "<option value='"+(64+e*16+j)+"'>" + e + "/" + (j+1) + "</option>";
	// 	}
	// }
	// o += "</select>";
    document.write(getBaseGateChannelSelectorHTML(id));
}


function changeMIDIChannel( id, ccid ) {
	if ( ccid != null ) {
		var show = ( document.getElementById( id ).value > 0 );
		document.getElementById( ccid ).style.display = show ? "inline" : "none";
		document.getElementById( ccid + "_rel" ).style.display = show ? "inline" : "none";
	}
}


function getMIDIChannelSelectorHTML( id, includeNone=false, ccid=null, visible=true ) {
    let o = '';
	o += `<select onchange='changeMIDIChannel("${id}","${ccid}")' id='${id}' ${visible ? '' : "style='display:none'"}>`;
	if ( includeNone ) {
		o += "<option value='-1'>--</option>";
	}
    o +=getOptionsHTML(1, 16, 0);
	o += "</select>";
    return o;
}
function writeMIDIChannelSelector( id, includeNone=false, ccid=null ) {
	// document.write( "<select onchange='changeMIDIChannel(\"" + id + "\",\"" + ccid + "\")' id='" + id + "'>" );
	// if ( includeNone ) {
	// 	document.write( "<option value='-1'>--</option>" );
	// }
    // document.write(getOptionsString(1, 16, 0));
	// document.write( "</select>" );
    document.write(getMIDIChannelSelectorHTML(id, includeNone, ccid));
}

function getMIDICCSelectorHTML( id, includeNone=true, hide=true, showRelative=true ) {
    let o = '';
    if (hide) {
        o += "<select id='" + id + "' style='display: none'>";
    } else {
        o += "<select id='" + id + "'>";
    }
	// o += "<select id='" + id + "'>" );
	if ( includeNone ) {
		o += "<option value='-1'>--</option>";
	}
    o += getOptionsHTML(0, 127, 0);
	o += "</select>";
	if ( showRelative ) {
        if (hide) {
            o += "<div title='Relative' class='relative_cb'><input type='checkbox' class='relative_cb' id='" + id + "_rel' style='display: none' /></div>";
        } else {
            o += "<div title='Relative' class='relative_cb'><input type='checkbox' class='relative_cb' id='" + id + "_rel' /></div>";
        }
	}
    return o;
	// if ( hide ) {
	// 	document.getElementById( id ).style.display = "none";
	// 	document.getElementById( id + '_rel' ).style.display = "none";
	// }
}

function writeMIDICCSelector( id, includeNone=true, hide=true, showRelative=true ) {
    document.write(getMIDICCSelectorHTML(id, includeNone, hide, showRelative));
}


function showHide( id, show ) {
	var ta = document.getElementById( id );
	ta.style.display = show ? "inline" : "none";
}

function showHideLFO( show ) {
    let elems = document.getElementsByClassName('lfo');
    for (let i = 0; i < elems.length; i++) {
        elems[i].style.display = show ? "table-cell" : "none";
    }
}

</script>

</head>

<body>

<!--
<div class="small">
At the time of writing this will work only in Google's <a href="http://www.google.com/chrome/">Chrome</a> browser or in the <a href="https://www.opera.com">Opera</a> browser. Chrome may block SysEx access if you run this from a website, in which case download the html file locally and run it from there.
</div>
-->

<div class="small" style="display:flex">
    This version is for FH-2 firmware v1.23 and above.
    <span class="margin-left"><a href="https://www.expert-sleepers.co.uk/downloads/manuals/fh2_user_manual_1.23.pdf" target="_blank">User manual (PDF)</a></span>
    <label class="margin-left">Theme: </label>
    <a href="#" style="margin-left:0.25rem" onclick="changeTheme('light')">Light</a>
    <a href="#" style="margin-left:0.25rem"onclick="changeTheme('dark')">Dark</a>
<!--    <select id="theme" onchange="changeTheme()">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>-->
    <div style="flex-grow:1;text-align:right">Custom version by <a href="https://francoisgeorgy.ch/" target="_blank">francoisgeorgy.ch</a></div>
</div>
<p class="margin-y">
    <span><strong>MIDI input:</strong> <select id="midiinput" onchange='changeInput()' accesskey='i'></select></span>
    <span class="margin-left"><strong>MIDI output:</strong> </label><select id="midioutput" onchange="changeOutput()" accesskey='o'></select></span>
    <span class="small margin-left" id="status"></span>
</p>
<p class="margin-y">
    <textarea rows=5 cols=50 id="log" class="log" readOnly title="Log" accesskey='l'></textarea>
    <textarea rows=5 cols=48 name="text" id="txSysex" title="Transmitted SysEx"></textarea>
    <textarea rows=5 cols=48 name="text" id="rxSysex" title="Received SysEx"></textarea>
</p>
<!--
<p class="margin-y">
    <button onclick="exportFile()">Export sysex file</button>
    <span class="margin-left ">Import sysex file: <input type="file" id="file-selector" /></span>
</p>
-->
<!--
<p class="margin-y">
    <button class="big" accesskey='u' onclick="request()">Read FH-2 config</button>
    <button class="big" accesskey='s' onclick="send()">Update FH-2 config</button>
    <button onclick="reqVersion()" accesskey='v' class="margin-left">Request FH-2 Version</button>
    <button onclick="sendMsg()">Send Msg</button>
</p>
-->
<table>
    <tr>
        <td valign="middle">
            <button class="big" accesskey='u' onclick="request()" style="background-color:#17e317;border-color:#17e317;color:#000"
                title="Read the current FH-2 configuration">Read FH-2</button>
            <button class="big" accesskey='s' onclick="sendWithConfirmation()" style="margin-left:1rem;background-color:#e31717;border-color:red"
                title="Update the current FH-2 configuration">Update FH-2</button>
        </td>
        <td valign="middle" style="padding-left:1rem">
            <button onclick="reqVersion()" accesskey='v'>Request FH-2 Version</button>
            <button onclick="sendMsg()" style="margin-left:0.25rem">Send Msg</button>
        </td>
        <td valign="middle" style="padding-left:1rem">
            Import sysex: <input type="file" id="file-selector" />
            <button onclick="exportFile()" style="margin-left:5px">Export sysex</button>
        </td>
        <td>
<!--            <button onclick="importData()">url&lt;</button>-->
            <button onclick="exportData()" style="margin-left:1rem">Update URL</button>
            <button onclick="clearData()" style="margin-left:0.25rem">Clear URL</button>
        </td>
    </tr>
</table>
<table>
    <tr>
        <td class="x-large">
            <label for="config_name">Configuration:</label> <input id='config_name' accesskey='n' type='text' class="large">
        </td>
        <td style="padding-left:2rem">
            <input type="hidden" id="pc_channel" value="0" />
            <table>
                <tr>
                    <td>
                        Load from config slot
                    </td>
                    <td>
                        <select id="configurationSlot" onChange="loadConfiguration()" style="width:8rem" title="Load a configuration slot into the current config">
                            <option value="-1">---</option>
                            <script>
                                document.write(getOptionsHTML(0, 29, 0, 1));
                            </script>
                        </select>
                    </td>
                    <td>&nbsp;</td>
                    <td>
                        <button onClick="selectPreviousConfiguration()">prev</button>
                        <button onClick="selectNextConfiguration()">next</button>
                    </td>
                    <td>&nbsp;</td>
                    <td>
                        <button onClick="scanConfiguration()" title="Read all the configuration slots names">Scan configurations slots</button>
                    </td>
                    <td>&nbsp;</td>
                    <td>
                        <span class="small">using ch.</span>
                        <select id="configurationChannelSelector">
                            <option value="0">1</option>
                            <option value="1">2</option>
                            <option value="2">3</option>
                            <option value="3">4</option>
                            <option value="4">5</option>
                            <option value="5">6</option>
                            <option value="6">7</option>
                            <option value="7">8</option>
                            <option value="8">9</option>
                            <option value="9">10</option>
                            <option value="10">11</option>
                            <option value="11">12</option>
                            <option value="12">13</option>
                            <option value="13">14</option>
                            <option value="14">15</option>
                            <option value="15" selected>16</option>
                        </select>
                    </td>
                </tr>
            </table>

        </td>
    </tr>
</table>
<div class="small" style="border-bottom:1px solid #999;margin:5px 0 10px 0;padding:5px 0;color:#ba7626" />
Remember that the tool is editing the FH-2's <strong>current</strong> configuration, much as if you were editing it with the FH-2's menus.<br />
    It does not save and recall configurations to/from flash memory.  Remember to save your configuration, using the FH-2's menus, if you want to keep it.
</div>

<!-- MENU -->
<p>
    <table class="show">
        <tr>
            <td><label><input id='glb_lbl' type='checkbox' onclick='showHide("glb_table",this.checked)' accesskey="b">Globals</input></label></td>
            <td><label><input id="showfh2outputs" type='checkbox' onclick='showHide("outs0_table",this.checked)' checked=true accesskey='w'>FH-2 Output Configurator</input></label></td>
            <td><label><input type='checkbox' id='clock_lbl' onclick='showHide("clk_table",this.checked)' checked=true accesskey='k'>Clocks</input></label></td>
            <td><label><input type='checkbox' id='euc_lbl' onclick='showHide("euc_table",this.checked)' accesskey='r'>Euclidean Patterns</input></label></td>
            <td><label><input type='checkbox' id='env_lbl' onclick='showHide("env_table",this.checked)'  accesskey='p'>Porta./Transp./Env.</input></label></td>
            <td><label><input type='checkbox' id='cvm_lbl' onclick='showHide("cvm_table",this.checked)' accesskey='c'>CV/MIDI</input></label></td>
            <td><label><input type='checkbox' id='srr_lbl' onclick='showHide("srr_table",this.checked)' accesskey='s'>Shift Reg Rand</input></label></td>
            <td><label><input type='checkbox' id='hid_lbl' onclick='showHide("hid_table",this.checked)' accesskey='h'>Gamepad</input></label></td>
        </tr>
        <tr>
            <td><label><input type='checkbox' id='conv_lbl' onclick='showHide("mcv_table",this.checked)' checked=true accesskey='m'>MIDI/CV</input></label></td>
            <td>FHX-8CV
                <script>
                    var i;
                    for ( i = 1; i < 8; ++i ) {
                        document.write(
                            "<label><input id='show8cvoutputs" + i + "' type='checkbox' accesskey='" + i +
                            "' onclick='showHide(\"outs" + i + "_table\", this.checked)'>" + i + "</input></label>" );
                    }
                </script></td>
            <td><label><input type='checkbox' id='trig_lbl' onclick='showHide("trg_table",this.checked)' accesskey='t'>Triggers</input></label></td>
            <td><label><input type='checkbox' id='seq_lbl' onclick='showHide("seq_table",this.checked)' checked=true accesskey='q'>Sequencers</input></label></td>
            <td><label><input type='checkbox' id='arp_lbl' onclick='showHide("arp_table",this.checked)'  accesskey='a'>Arpeggiators</input></label></td>
            <td><label><input type='checkbox' id='lfo_lbl' onclick='showHideLFO(this.checked)'  accesskey='f'>LFO</input></label></td>
            <td><label><input type='checkbox' id='kbd_lbl' onclick='showHide("kbd_table",this.checked)' accesskey='y'>HID Keyboard</input></label></td>
            <td></td>
        </tr>
    </table>
<!--<br>
<input type='checkbox' onclick='showHide("menus_table",this.checked)'>Show Settings/Menus</input>
<br>
<input type='checkbox' onclick='showHide("noteccs_table",this.checked)' accesskey='n'>Show Note-to-CC Maps</input>
<br>
<label class = 'hidden' for='misc_lbl'>Show Miscellaneous</label>
<input type='checkbox' id='misc_lbl' onclick='showHide("misc_table",this.checked)' accesskey='x'>Show Miscellaneous</input>
<p>-->
<p>

<!-- GLOBAL -->
<table id="glb_table">
<thead>
<tr>
    <th colspan=25 class="bg-blue">Globals</th>
</tr>
<tr class="a">
    <th rowspan=2>Legato<br>velocity</th>
    <th rowspan=2>Global<br>transpose</th>
    <th rowspan=2>Trigger<br>length</th>
    <th rowspan=2>Ext Clock<br>Multiplier</th>
    <th rowspan=2>Ext Clock<br>Run Control</th>
    <th rowspan=2>Euclidean<br>Accent</th>
    <th>Preset Program Change</th>
    <th rowspan=2>Soft<br>takeover</th>
    <th colspan=3>Tap Tempo</th>
    <th colspan=3>Start/Stop</th>
    <th colspan=3>Internal tempo</th>
    <th colspan=2>Swing type/amount</th>
    <th colspan=2>Display mode/item</th>
    <th>Nudge faster</th>
    <th>Nudge slower</th>
    <th>Inc tempo</th>
    <th>Dec tempo</th>
</tr>
<tr class="b">
    <th>Channel</th>
    <th>Type</th><th>Channel</th><th>Note or CC</th>
    <th>Type</th><th>Channel</th><th>Note or CC</th>
    <th>Channel/CC</th><th>Min</th><th>Max</th>
    <th>Channel/CC</th><th>Channel/CC</th>
    <th>Channel/CC</th><th>Channel/CC</th>
    <th>Channel/CC</th>
    <th>Channel/CC</th>
    <th>Channel/CC</th>
    <th>Channel/CC</th>
</tr>
</thead>
<tbody>
<tr class="a">
<td><input type='checkbox' checked id='glb_legvel'></td>
<td><select id='glb_transpose'>
<script>
        document.write(getOptionsHTML(-48, 48, 0));
</script>
</select></td>
<td><select id='glb_triglen'>
<script>
        document.write(getOptionsHTML(1, 100, 0));
</script>
</select></td>
<td><select id='glb_extclkmult'>
<script>
        document.write(getOptionsHTML(1, 96, 0));
</script>
</select></td>
<td><select id='glb_extclkrun'>
<option value=0>None</option><option value=1>Run/Stop on Y</option>
</select></td>
<td><select id='glb_eucaccent'>
<script>
        document.write(getOptionsHTML(0, 127, 0, 1));
</script>
</select></td>
<td><select id='glb_presetprogch'>
<option value='0'>Off</option>
<script>
        document.write(getOptionsHTML(1, 16, 0));
</script>
</select></td>

<td><input type='checkbox' id='glb_softtakeover'></td>

<td><select id='glb_taptype'>
<option value=0>None</option><option value=1>Note</option><option value=2>CC</option>
</select></td>
<td><script>
		writeMIDIChannelSelector( 'glb_tapch' );
</script></td>
<td><script>
		writeMIDICCSelector( 'glb_tapcc', false, false );
</script></td>

<td><select id='glb_starttype' onchange='changeStartStop()'>
<option value=0>None</option><option value=1>Note Toggle</option><option value=2>CC Toggle</option><option value=3>Note Gate</option><option value=4>CC Gate</option>
<option value=5>Y Toggle</option><option value=6>Y Gate</option>
</select></td>
<td><script>
		writeMIDIChannelSelector( 'glb_startch' );
</script></td>
<td><script>
		writeMIDICCSelector( 'glb_startcc', false, false );
</script></td>

<td><script>
	var ccid = "glb_tempo_cc";
	writeMIDIChannelSelector( "glb_tempo_ch", true, ccid );
	writeMIDICCSelector( ccid );
</script></td>
<td><select id='glb_tempo_min'><script>
        document.write(getOptionsHTML(0, 127, 0, 1));
</script></select></td>
<td><select id='glb_tempo_max'><script>
        document.write(getOptionsHTML(0, 127, 0, 128));
</script></select></td>

<td><script>
	var ccid = "glb_swing_type_cc";
	writeMIDIChannelSelector( "glb_swing_type_ch", true, ccid );
	writeMIDICCSelector( ccid );
</script></td>
<td><script>
	var ccid = "glb_swing_amount_cc";
	writeMIDIChannelSelector( "glb_swing_amount_ch", true, ccid );
	writeMIDICCSelector( ccid );
</script></td>
<td><script>
	var ccid = "dispmode_cc";
	writeMIDIChannelSelector( "dispmode_ch", true, ccid );
	writeMIDICCSelector( ccid );
</script></td>
<td><script>
	var ccid = "dispitem_cc";
	writeMIDIChannelSelector( "dispitem_ch", true, ccid );
	writeMIDICCSelector( ccid );
</script></td>

<td><script>
	writeMIDIChannelSelector( "nudgefaster_ch", true, "nudgefaster_cc" );
	writeMIDICCSelector( "nudgefaster_cc", true, true, false );
</script></td>
<td><script>
    writeMIDIChannelSelector( "nudgeslower_ch", true, "nudgeslower_cc" );
	writeMIDICCSelector( "nudgeslower_cc", true, true, false );
</script></td>
<td><script>
    writeMIDIChannelSelector( "inctempo_ch", true, "inctempo_cc" );
	writeMIDICCSelector( "inctempo_cc", true, true, false );
</script></td>
<td><script>
    writeMIDIChannelSelector( "dectempo_ch", true, "dectempo_cc" );
	writeMIDICCSelector( "dectempo_cc", true, true, false );
</script></td>

    </tr>
    </tbody>
    </table>
    <script>
        changeStartStop();
        document.getElementById( "glb_transpose" ).value = 0;
        document.getElementById( "glb_triglen" ).value = 50;
</script>

<!-- MIDI/CV -->
<table id="mcv_table" style="margin-top:10px">

    <tr>
<th colspan=8  class="bg-blue">MIDI/CV Converters</th>
<th class="tc bg-blue" colspan=10>Per voice outputs</th>
<th class="tc bg-blue" colspan=3>Paraphonic outputs</th>
<td></td>
<td></td>
<td></td><td></td><td></td><td></td><td></td>
<th class="tc bg-blue">Up</th><th class="tc bg-blue">Down</th>
<td></td>
<td></td>
<td></td>
</tr>


<tr>
<th><div class='rth'>Converter</div></th><th><div class='rth'>Enable</div></th><th>MIDI<br>Channel</th><th colspan=2>Note range</th><th>Type</th>
<th>Base<br>Output</th><th>Base<br>Gate</th>
<th><div class='rth'>CV</div></th><th><div class='rth'>Gate</div></th><th><div class='rth'>Velocity<br>Gate</div></th><th><div class='rth'>Velocity</div></th><th><div class='rth'>Release<br>Velocity</div></th><th><div class='rth'>Trigger</div></th><th><div class='rth'>Envelope</div></th><th><div class='rth'>Aftertouch</div></th><th><div class='rth'>Random</div></th><th><div class='rth'>Y</div></th>
<th><div class='rth'>Gate</div></th><th><div class='rth'>Aftertouch</div></th><th><div class='rth'>Bend</div></th>
<th><div class='rth'>Gated<br>Aftertouch</div></th>
<th>Sustain</th>
<th>Voice<br>allocation</th><th>Prevent<br>stealing</th><th>Voices</th><th>Stride</th><th>Last<br>channel</th>
<th colspan=2>Bend<br>range</th>
<th><div class='rth'>Mono<br>retrigger</div></th>
<th><div class='rth'>Interrupt<br>gate</div></th>
<th><div class='rth'>Env<br>zero</div></th>
</tr>
<!--
<tr>
<th colspan=8  class="bg-blue">MIDI/CV Converters</th>
<th class="tc" colspan=10>Per voice outputs</th>
<th class="tc" colspan=3>Paraphonic outputs</th>
<td></td>
<td></td>
<td></td><td></td><td></td><td></td><td></td>
<th class="tc">Up</th><th class="tc">Down</th>
<td></td>
<td></td>
<td></td>
</tr>
-->
<tr class="a"><td colspan="8"></td><td colspan="9"></td><td class='tc'>CC</td><td colspan="3"></td><td colspan="12"></td>
</tr>
<script>
	for ( i = 1; i < 17; ++i ) {
		var cl = ( i & 1 ) ? "b" : "a";

        let o = '';

		o += "<tr class=" + cl + "><th>" + i + "</th>";
		
		var id = "mcv_enable_" + i;
		o += "<td title='Enable MIDI-CV converter " + i + "'><input type='checkbox' id='" + id + "'></input></td>";
		id = "mcv_ch_" + i;
		o += "<td title='MIDI Channel (Converter " + i + ")'>";

        // document.write(o);
        // o = '';

		o += getMIDIChannelSelectorHTML( id );

		o += "</td>";
		id = "mcv_min_" + i;
		o += "<td title='Minimum MIDI note number (Converter " + i + ")'><select id='" + id + "'>" + getOptionsHTML(0, 127, 0) + "</select></td>";
		id = "mcv_max_" + i;
		o += "<td title='Maximum MIDI note number (Converter " + i + ")'><select id='" + id + "'>" + getOptionsHTML(0, 127, 0, 0, 127) + "</select></td>";

        // document.write(o);
        // o = '';
		// var ta = document.getElementById( id );
		// ta.value = "127";

		id = "mcv_type_" + i;
		o += "<td title='Type (Converter " + i + ")'><select onchange='changeType(" + i + ")' id='" + id + "'>";
		o += "<option value=0>Mono</option><option value=1>Poly</option><option value=2>MPE</option>";
		o += "</select></td>";

		id = "mcv_base_" + i;
		// o += "<td title='Base output (Converter " + i + ")'>" );
		// writeChannelSelector( id, false );
		// o += "</td>" );
        o += "<td title='Base output (Converter " + i + ")'>" + getChannelSelector(id, false) + "</td>";

		id = "mcv_basegate_" + i;
		o += "<td title='Base gate (Converter " + i + ")'>";
		o += getBaseGateChannelSelectorHTML( id );
		o += "</td>";

		var c = [ "C", "G", "VG", "V", "R", "T", "E", "P", "RND" ];
		let type = [ 0, 0, 0, 1, 1, 0, 0, 0, 0 ];
		var k;

		for ( k=0; k<9; ++k ) {
			var param_label;

			if (k == 0) 
            {
                param_label = "CV";
            }
            else if (k == 1)
            {
                param_label = "Gate";
            }
            else if (k == 2)
            {
                param_label = "Velocity Gate";
            }
            else if (k == 3)
            {
                param_label = "Velocity";
            }
            else if (k == 4)
            {
                param_label = "Release Velocity";
            }
            else if (k == 5)
            {
                param_label = "Trigger";
            }
            else if (k == 6)
            {
                param_label = "Envelope";
            }
            else if (k == 7)
            {
                param_label = "MPE Aftertouch";
            }
            else if (k == 8)
            {
                param_label = "Random";
            }
            else
            {
                param_label = "unknown";
            }

			id = "mcv_V" + c[k] + "_" + i;
			o += "<td title='" + param_label + " (Converter " + i + ")'>";

			if ( type[k] ) {
			    o += `<select id='${id}'><option value=0>--</option><option value=1>On</option><option value=2>Inv</option></select></td>`;
			} else {
                o += "<input type='checkbox' id='" + id + "'></td>";
			}

		}

		id = "mcv_VY_" + i;
		o += "<td title='MPE Y-axis MIDI CC (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
		o += "<option value='0'>--</option>";
        o += getOptionsHTML(1, 127, 0);
		o += "</select></td>";

		var c = [ "G", "A" ];
		for ( k=0; k<2; ++k ) {
			var param_label;

            if (k == 0)
            {
                param_label = "Paraphonic Gate";
            }
            else if (k == 1)
            {
                param_label = "Paraphonic Aftertouch";
            }
            else
            {
                param_label = "unknown";
            }

			id = "mcv_" + c[k] + "_" + i;
			o += "<td title='" + param_label + " (Converter " + i + ")'>";
			o += "<input type='checkbox' id='" + id + "'></td>";
		}

		id = "mcv_PB_" + i;
		o += "<td title='Pitch Bend output (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
		o += "<option value='0'>--</option><option value='1'>Single</option><option value='2'>Double</option>";
		o += "</select></td>";

		id = "mcv_GA_" + i;
		o += "<td title='Gated Aftertouch (Converter " + i + ")'>";
		o += "<input type='checkbox' id='" + id + "'></td>";

		id = "mcv_SUS_" + i;
		o += "<td title='Sustain (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
		o += "<option value=0>Off</option><option value=1>Sustain</option><option value=2>Sostenuto</option><option value=3>Both</option>";
		o += "</select></td>";

		id = "mcv_scheme_" + i;
		o += "<td title='Voice Allocation (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
		o += "<option value=0>Round robin</option><option value=1>Lowest voice</option><option value=2>Unison</option><option value=3>Unison 2</option><option value=4>Note range</option><option value=5>Alternating</option><option value=6>Random</option>";
		o += "</select></td>";

		id = "mcv_stealing_" + i;
		o += "<td title='Prevent Stealing (Converter " + i + ")'>";
		o += "<input type='checkbox' id='" + id + "'></td>";

		id = "mcv_voices_" + i;
		o += "<td title='Voices (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
        o += getOptionsHTML(1, 16, 0);
		o += "</select></td>";

		id = "mcv_stride_" + i;
		o += "<td title='Stride (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
        o += getOptionsHTML(1, 32, 0);
		o += "</select></td>";

		id = "mcv_lastMPE_" + i;
		o += "<td title='Last MPE MIDI Channel (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
        o += getOptionsHTML(2, 16, 0);
		o += "</select></td>";

		id = "mcv_bend_" + i;
		o += "<td title='Bend Range (Converter " + i + ")'>";
		o += "<select id='" + id + "'>";
        o += getOptionsHTML(0, 64, 0);
        o += "</select></td>";
		id = "mcv_benddown_" + i;
		o += "<td><select id='" + id + "'><option value='0'>Same</option>";
        o += getOptionsHTML(0, 64, 1);
		o += "</select></td>";

		id = "mcv_MT_" + i;
		o += "<td title='Mono Retrigger(Converter " + i + ")'>";
		o += "<input type='checkbox' id='" + id + "'></td>";

		id = "mcv_IG_" + i;
		o += "<td title='Interrupt Gate(Converter " + i + ")'>";
		o += "<input type='checkbox' id='" + id + "'></td>";

		id = "mcv_ZS_" + i;
		o += "<td title='Env Zero(Converter " + i + ")'>";
		o += "<input type='checkbox' id='" + id + "'></td>";
		
		o += "</tr>";
        document.write(o);

		changeType( i );
	}
</script>
</table>

<!-- OUTPUTS -->
<script>
    function setRangeColor(id) {
        let e = document.getElementById(id);
        e.classList.remove("range-0", "range-1", "range-2", "range-3", "range-4");
        e.classList.add("range-" + e.value);
    }

    function changeLfoReset( out ) {
        var t = document.getElementById( "lfotrig_type_" + out ).value;
        document.getElementById( "lfotrig_ch_" + out ).style.display = ( t > 0 && t < 6 ) ? "inline" : "none";
        document.getElementById( "lfotrig_cc_" + out ).style.display = ( ( t > 0 && t < 3 ) || ( t >= 6 && t <= 7  ) ) ? "inline" : "none";
        document.getElementById( "lfotrig_ch_" + out + "_lab" ).innerHTML = ( t > 0 && t < 3 ) ? "Channel" : ( t >= 3 && t <= 5 ) ? "MIDI/CV" : "";
        document.getElementById( "lfotrig_cc_" + out + "_lab" ).innerHTML = ( t == 1 ) ? "CC" : ( t == 2 ) ? "Note" : ( t == 6 ) ? "Clock" : ( t == 7 ) ? "Euclidean" : "";
    }

    var ac = [ "DC", "LFO", "CLK", "CLKM", "MLT", "SIN", "SQR", "PW", "TRI", "SAW", "RND", "NSE", "PHS", "FAD", "SMO" ];
    var acc = [ 0, 1, 7, 8, 2, 3, 4, 6, 5, 3,  4,  5,  7,  8,  6 ];
    var aco = [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 64, 64, 64, 64, 64 ];
    var acMapLow = new Int8Array( ac.length );
    var acMapHigh = new Int8Array( ac.length );
    for ( var i=0; i<ac.length; ++i ) {
        acMapLow[i] = -1;
        acMapHigh[i] = -1;
    }
    for ( var i=0; i<ac.length; ++i ) {
        if ( aco[i] > 0 ) {
            acMapHigh[ acc[i] ] = i;
        }
        else {
            acMapLow[ acc[i] ] = i;
        }
    }

    var id;
    var x;
    for ( x = 0; x < 8; ++x ) {

        let outsHtml = '';

        outsHtml += "<table id='outs" + x + "_table'>";
        outsHtml += "<tr><th colspan=4 class=\"bg-blue\">" + ( x ? ( "Expander " + x ) : "FH-2" ) + " outputs</th><th colspan=2 class='lfo'>LFO Tempo-based</th>";
        outsHtml += "<th colspan=13 class=\"lfo\">LFO</th>";
        outsHtml += "<th colspan=3 class=\"bg-blue\">" + ( x ? ( "Expander " + x ) : "FH-2" ) + "</th></tr>";
        outsHtml += "<tr><td></td><th>Output Range</th><th>Direct Control</th><th>LFO Speed</th><th class=\"lfo\">Base</th><th class=\"lfo\">Multiplier</th><th class=\"lfo\">LFO Level</th>";
        outsHtml += "<th class=\"lfo\">Sine</th><th class=\"lfo\">Square</th><th class=\"lfo\">PW</th><th class=\"lfo\">Triangle</th><th class=\"lfo\">Saw</th>";
        outsHtml += "<th class=\"lfo\">Random</th><th class=\"lfo\">Noise</th><th class=\"lfo\">Phase</th><th colspan=3 class=\"lfo\">Reset</th><th class=\"lfo\">Fade</th>";
        outsHtml += "<th>Smoothing</th><th colspan=2>Gate Levels</th>";
        outsHtml += "</tr>";
        outsHtml += "<tr class='a'>";
        outsHtml += "<th>Output</th><td></td>";
        for ( j=0; j<2; ++j ) {
            outsHtml += "<td class='tc'>Channel/CC</td>";
        }
        for ( j=2; j<ac.length-2; ++j ) {
            outsHtml += "<td class='tc lfo'>Channel/CC</td>";
        }
        outsHtml += "<td class='tc lfo'>Type</td><td class='tc lfo'>Set 1</td><td class='tc lfo'>Set 2</td>";
        outsHtml += "<td class='tc lfo'>Channel/CC</td><td class='tc'>Channel/CC</td>";
        outsHtml += "<th>Low</th><th>High</th>";
        outsHtml += "</tr>";

        document.write(outsHtml);

        for ( i = 0; i < 8; ++i ) {

            outsHtml = '';

            var cl = ( i & 1 ) ? "a" : "b";
            outsHtml += "<tr class=" + cl + "><td class='number'>" + (i+1) + "</td>";
            var out = x * 8 + i;

            var id = "rng_" + (out+1);
            outsHtml += "<td title='Range (Output " + (i + 1) + ")'>";
            outsHtml += "<select id='" + id + "' onChange='setRangeColor(\"" + id + "\")'>";
            outsHtml += "<option value=0>0-10V</option><option value=1>&plusmn;5V</option><option value=2>0-1V</option><option value=3>0-5V</option><option value=4>0-8V</option>";
            outsHtml += "</select></td>";
            // setRangeColor(id);

            for ( j=0; j<ac.length; ++j ) {
                var chid = "out_" + ac[j] + "_ch_" + out;
                var ccid = "out_" + ac[j] + "_cc_" + out;
                var param_label;

                if (j == 0)
                {
                    param_label = "direct control";
                }
                else if (j == 1)
                {
                    param_label = "LFO speed";
                }
                else if (j == 2)
                {
                    param_label = "base";
                }
                else if (j == 3)
                {
                    param_label = "Multiplier";
                }
                else if (j == 4)
                {
                    param_label = "level";
                }
                else if (j == 5)
                {
                    param_label = "sine";
                }
                else if (j == 6)
                {
                    param_label = "square";
                }
                else if (j == 7)
                {
                    param_label = "PW";
                }
                else if (j == 8)
                {
                    param_label = "triangle";
                }
                else if (j == 9)
                {
                    param_label = "saw";
                }
                else if (j == 10)
                {
                    param_label = "random";
                }
                else if (j == 11)
                {
                    param_label = "noise";
                }
                else if (j == 12)
                {
                    param_label = "phase";
                }
                else if (j == 13)
                {
                    param_label = "fade";
                }
                else if (j == 14)
                {
                    param_label = "smoothing";
                }

                if (j>= 2 && j<=13) {
                    outsHtml += "<td class='lfo'>";
                } else {
                    outsHtml += "<td>";
                }

                outsHtml += getMIDIChannelSelectorHTML( `out_${ac[j]}_ch_${out}`, true, ccid );
                outsHtml += getMIDICCSelectorHTML( ccid );
                outsHtml += "</td>";
                if ( j == 12 )
                {
                    var id = `lfotrig_type_${out + 1}`;
                    outsHtml += `<td title='Reset type (Output ${i + 1})' class='lfo'>`;
                    outsHtml += `<select id='${id}' onchange='changeLfoReset("${out + 1}")'>`;
                    outsHtml += "<option value=0>Off</option><option value=1>CC</option><option value=2>Note</option><option value=3>Any note</option><option value=4>Paraphonic</option><option value=5>Poly voice</option>";
                    outsHtml += "<option value=6>Clock</option><option value=7>Euclidean</option>";
                    outsHtml += "</select></td>";
                    var id = `lfotrig_ch_${out + 1}`;
                    outsHtml += `<td class='lfo'><div class='tc_c' id='${id}_lab'></div>`;
                    outsHtml += `<select id='${id}'>`;
                    outsHtml += getOptionsHTML(1, 16, -1, 0);
                    outsHtml += "</select></td>";
                    var ccid = `lfotrig_cc_${out + 1}`;
                    outsHtml += `<td class='lfo'><div class='tc_c' id='${ccid}_lab'></div>`;
                    outsHtml += getMIDICCSelectorHTML( ccid, false );
                    outsHtml += "</td>";
                }
            }

            var gtid = `out_gt_${out}`;
            id = gtid + "_lo";
            outsHtml += `<td title='Gate level - low (Output ${i + 1})'>`;
            outsHtml += `<input onchange='changeGateLevel("${id}")' type='text' id='${id}' min=0 max=16383 size=5 type='number' value='0'></td>`;
            id = gtid + "_hi";
            outsHtml += `<td title='Gate level - high (Output ${i + 1})'>`;
            outsHtml += `<input onchange='changeGateLevel("${id}")' type='text' id='${id}' min=0 max=16383 size=5 type='number' value='16383'></td>`;

            outsHtml += "</tr>";
            document.write(outsHtml);

            changeLfoReset( out+1 );
        }

        document.write("</table>");

        // document.write(outsHtml);

        if ( x > 0 ) {
            showHide( "outs" + x + "_table", false );
        }
    }

</script>

<!-- PORTAMENTO/ENVELOPES -->
<table id="env_table">
    <thead>
    <tr>
        <th></th>
        <th class="bg-blue">Portamento</th>
        <th class="bg-blue">Transpose</th>
        <th class="bg-blue" colspan=7>Envelopes</th>
        <th class="bg-blue">Random</th>
    </tr>
    <tr>
        <th></th>
        <th></th>
        <th></th>
        <th>Attack</th><th>Decay</th><th>Sustain</th><th>Release</th><th>Range</th><th>Depth</th><th>Velocity Depth</th>
        <th></th>
    </tr>
    </thead>
    <tr>
        <td></td>
        <td class='tc' colspan=10>Preset Items - Channel/CC</td>
    </tr>
    <script>

        let clkHtml = '';
        for ( i = 1; i < 17; ++i ) {

            var cl = ( i & 1 ) ? "b" : "a";
            clkHtml += "<tr class=" + cl + "><td class='number'>" + i + "</td>";

            for ( var j=0; j<arpControlsUI.length; ++j ) {
                var chid = "arpeg" + i + "_" + arpControlsUI[j] + "_ch";
                var ccid = "arpeg" + i + "_" + arpControlsUI[j] + "_cc";
                var param_label;

                if (j == 0)
                {
                    param_label = "portamento";
                }
                else if (j == 1)
                {
                    param_label = "transpose";
                }
                else
                {
                    param_label = "error: unknown parameter";
                }

                clkHtml += "<td>";
                clkHtml += getMIDIChannelSelectorHTML( chid, true, ccid );
                clkHtml += getMIDICCSelectorHTML( ccid );
                clkHtml += "</td>";
            }
            for ( var j=0; j<mcvMappable2Controls.length; ++j ) {
                var chid = "mcvm2_" + i + "_" + mcvMappable2Controls[j] + "_ch";
                var ccid = "mcvm2_" + i + "_" + mcvMappable2Controls[j] + "_cc";
                var param_label;

                if (j == 0)
                {
                    param_label = "env. attack";
                }
                else if (j == 1)
                {
                    param_label = "env. decay";
                }
                else if (j == 2)
                {
                    param_label = "env. sustain";
                }
                else if (j == 3)
                {
                    param_label = "env. release";
                }
                else if (j == 4)
                {
                    param_label = "env. range";
                }
                else if (j == 5)
                {
                    param_label = "env. depth";
                }
                else if (j == 6)
                {
                    param_label = "env. velocity depth";
                }
                else if (j == 7)
                {
                    param_label = "random depth";
                }
                else
                {
                    param_label = "error: unknown parameter";
                }

                clkHtml += "<td>";
                clkHtml += getMIDIChannelSelectorHTML( chid, true, ccid );
                clkHtml += getMIDICCSelectorHTML( ccid );
                clkHtml += "</td>";
            }
            clkHtml += "</tr>";
        }
        document.write(clkHtml);
    </script>
</table>

<!-- ARPEGGIATOR -->
<table id="arp_table">
    <thead>
    <tr>
        <th colspan=19 class="bg-blue">Arpeggiator</th>
    </tr>
    <tr>
        <td></td>
        <th>Mode</th><th>Range</th><th>Gate Length</th><th>Latch</th><th>Rate</th><th>Reset</th>
        <th>Add</th><th>Remove</th><th>Rest</th><th>Truncate</th><th>Transpose</th><th>Transp. in key</th><th>Set root</th><th>Clock source</th>
        <th>USB C</th><th>USB A</th><th>DIN</th><th>Channel</th>
    </tr>
    </thead>
    <tr>
        <td></td>
        <td class='tc' colspan=6>Preset Items - Channel/CC</td>
        <td class='tc_a' colspan=7>Commands - Channel/CC</td>
        <td class='tc'>(for rate 0)</td>
        <td class='tc' colspan=4>MIDI out</td>
    </tr>
    <script>
        let arpHtml = '';
        for ( i = 1; i < 17; ++i ) {
            var cl = ( i & 1 ) ? "b" : "a";
            arpHtml += "<tr class=" + cl + "><td>" + i + "</td>";
            for ( var j=0; j<arpControlsUI2.length; ++j ) {
                var chid = "arpeg" + i + "_" + arpControlsUI2[j] + "_ch";
                var ccid = "arpeg" + i + "_" + arpControlsUI2[j] + "_cc";
                var param_label;

                if (j == 0)
                {
                    param_label = "arp. mode";
                }
                else if (j == 1)
                {
                    param_label = "arp. range";
                }
                else if (j == 2)
                {
                    param_label = "arp. gate length";
                }
                else if (j == 3)
                {
                    param_label = "arp. latch";
                }
                else if (j == 4)
                {
                    param_label = "arp. rate";
                }
                else if (j == 5)
                {
                    param_label = "arp. reset";
                }
                else
                {
                    param_label = "error: unknown parameter";
                }

                arpHtml += "<td>";
                arpHtml += getMIDIChannelSelectorHTML( chid, true, ccid );
                arpHtml += getMIDICCSelectorHTML( ccid );
                arpHtml += "</td>";
            }
            for ( var k=0; k<mcvCommands.length; ++k ) {
                var chid = "mcvcom" + i + "_" + mcvCommands[k] + "_ch";
                var ccid = "mcvcom" + i + "_" + mcvCommands[k] + "_cc";
                var param_label;

                if (k == 0)
                {
                    param_label = "arp. add notes";
                }
                else if (k == 1)
                {
                    param_label = "arp. remove notes";
                }
                else if (k == 2)
                {
                    param_label = "arp. rest";
                }
                else if (k == 3)
                {
                    param_label = "arp. truncate";
                }
                else if (k == 4)
                {
                    param_label = "arp. transpose";
                }
                else if (k == 5)
                {
                    param_label = "arp. transpose in key";
                }
                else if (k == 6)
                {
                    param_label = "arp. set root";
                }
                else
                {
                    param_label = "error: unknown parameter";
                }

                arpHtml += "<td>";
                arpHtml += getMIDIChannelSelectorHTML( chid, true, ccid );
                arpHtml += getMIDICCSelectorHTML( ccid );
                arpHtml += "</td>";
            }

            let id = "arp_" + i + "_clk";
            arpHtml += `<td><label class='hidden' for='${id}'>Arpeggiator ${i + 1} external clock source</label>`;
            arpHtml += `<select id='${id}'>`;
            arpHtml += `<option value=0>External</option>`;
            for ( let j=1; j<=16; ++j ) {
                arpHtml += `<option value=${j}>Euclidean ${j}</option>`;
            }
            arpHtml += `</select></td>`;
            arpHtml += `<td><input type='checkbox' id='arp_out_${i}_c'></td>`;
            arpHtml += `<td><input type='checkbox' id='arp_out_${i}_a'></td>`;
            arpHtml += `<td><input type='checkbox' id='arp_out_${i}_d'></td>`;
            arpHtml += `<td>`;
            arpHtml += getMIDIChannelSelectorHTML(`arp_out_${i}_ch`);
            arpHtml += `</td>`;
            arpHtml += "</tr>";
        }
        document.write(arpHtml);
    </script>
</table>

<!-- EUCLIDEAN PATTERNS -->
<table id="euc_table">
    <tr>
        <th colspan=10 class="bg-blue">Euclidean Patterns</th>
    </tr>
    <tr><td></td><th>Output</th><th>Off Output</th>
        <th>Pulses</th><th>Steps</th><th>Rotation</th><th>Rate</th><th>Gate Length</th><th>Accent Rate</th><th>Reset</th>
    </tr>
    <tr><th></th><th colspan=2></th>
<!--    <tr><td></td><td></td><td></td>-->
        <td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td>
        <td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td>
    </tr>
    <script>
        let eucHtml = '';
        for ( i = 1; i < 17; ++i ) {
            var cl = ( i & 1 ) ? "a" : "b";
            eucHtml += "<tr class=" + cl + "><td>" + i + "</td>";
            id = "euc_output_" + i;
            eucHtml += "<td title='Output (Pattern " + i + ")'>";
            eucHtml += getGateChannelSelectorHTML( id, true, i-1 );
            eucHtml += "</td>";
            // document.getElementById( id ).value = i-1;
            id = "euc_offoutput_" + i;
            eucHtml += "<td title='Off output (Pattern " + i + ")'>";
            eucHtml += getGateChannelSelectorHTML( id, true );
            eucHtml += "</td>";
            for ( var j=0; j<eucControls.length; ++j ) {
                var param_label;
                var chid = "euc_" + i + "_" + eucControls[j] + "_ch";
                var ccid = "euc_" + i + "_" + eucControls[j] + "_cc";

                if (j == 0)
                {
                    param_label = "Pulses";
                }
                else if (j == 1)
                {
                    param_label = "Steps";
                }
                else if (j == 2)
                {
                    param_label = "Rotation";
                }
                else if (j == 3)
                {
                    param_label = "Rate";
                }
                else if (j == 4)
                {
                    param_label = "Gate Length";
                }
                else if (j == 5)
                {
                    param_label = "Accent Rate";
                }
                else if (j == 6)
                {
                    param_label = "Reset";
                }
                else
                {
                    param_label = "error: unknown parameter";
                }

                eucHtml += "<td>";
                eucHtml += getMIDIChannelSelectorHTML( chid, true, ccid );
                eucHtml += getMIDICCSelectorHTML( ccid );
                eucHtml += "</td>";

            }
        }
        document.write(eucHtml);
    </script>
</table>

<!-- SRR -->
<table id="srr_table"><caption class="hidden">Shift Register Random</caption>
<tr>
<th colspan=19 class="bg-blue">Shift Register Random</th>
</tr>
<tr><td></td><th colspan=3>Outputs</th><th class='tc'>Notes input</th><th class='tc' colspan=5>MIDI output</th><th>Clock source</th>
<th>Direction</th><th>Length</th><th>Randomness</th><th>Rate</th><th>Attenuator</th><th>Scale</th><th>Key</th>
<th>Gate Length</th>
</tr>
<tr><th></th><th>CV</th><th>Change</th><th>Trigger</th><th>Channel</th><th>Channel</th><th>Internal</th><th>USB C</th><th>USB A</th><th>DIN</th><th>(for rate 0)</th>
<td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td>
<td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td><td class='tc'>Channel/CC</td>
</tr>
<script>
	for ( i = 1; i < 17; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + i + "</td>" );
		id = "srr_output_" + i;
		document.write( "<td><label class='hidden' for='" + id + "'>Output (Random " + i + ")</label>");
		writeChannelSelector( id, true );
		document.write( "</td>" );
		document.getElementById( id ).value = i - 1;

		id = "srr_change_" + i;
		document.write( "<td><label class='hidden' for='" + id + "'>Change output (Random " + i + ")</label>");
		writeGateChannelSelector( id, true );
		document.write( "</td>" );

		id = "srr_trigger_" + i;
		document.write( "<td><label class='hidden' for='" + id + "'>Trigger output (Random " + i + ")</label>");
		writeGateChannelSelector( id, true );
		document.write( "</td>" );

		document.write( "<td>" );
    	writeMIDIChannelSelector( "srr_nch_" + i, true, null );
		document.write( "</td>" );

		document.write( "<td>" );
    	writeMIDIChannelSelector( "srr_ch_" + i, false, null );
		document.write( "</td>" );
		document.write( "<td><input type='checkbox' id='srr_int_" + i + "'></td>" );
		document.write( "<td><input type='checkbox' id='srr_c_" + i + "'></td>" );
		document.write( "<td><input type='checkbox' id='srr_a_" + i + "'></td>" );
		document.write( "<td><input type='checkbox' id='srr_d_" + i + "'></td>" );

		id = "srr_clk_" + i;
		document.write( "<td><label class='hidden' for='" + id + "'>Random " + (i + 1) + " external clock source</label>" );
		document.write( "<select id='" + id + "'>" );
		document.write( "<option value=0>External</option>" );
		for ( let j=1; j<=16; ++j ) {
			document.write( "<option value=" + j + ">Euclidean " + j + "</option>" );
		}
		document.write( "</select></td>" );

		for ( var j=0; j<srrControls.length; ++j ) {
			var param_label = "";
			var chid = "srr_" + i + "_" + srrControls[j] + "_ch";
			var ccid = "srr_" + i + "_" + srrControls[j] + "_cc";
			document.write( "<td><label class='hidden' for='" + chid + "'>" + param_label + " MIDI channel (Random " + i + ")</label>");
			writeMIDIChannelSelector( chid, true, ccid );
			document.write( "<label class='hidden' for='" + ccid  + "'>" + param_label + "MIDI CC (Random " + i + ")</label>");
			writeMIDICCSelector( ccid );
			document.write( "</td>" );
		}
	}
</script>
</table>

<!-- SEQUENCERS -->
<table id="seq_table">
    <tr>
        <th colspan=7 class="bg-blue">Sequencers</th>
    </tr>
    <tr><td></td><th>MIDI channel</th><th>Internal</th><th>USB C</th><th>USB A</th><th>DIN</th><th>Clock source</th><th colspan=8>Notes</th></tr>
    <tr><th>Note sequencers</th><th colspan=5></th><th>(for rate 0)</th></tr>
    <script>
        let oSeq = '';
        for ( let i=0; i<4; ++i ) {
            let cl = ( i & 1 ) ? "a" : "b";
            oSeq += "<tr class=" + cl + "><td>" + (i+1) + "</td><td>";
            // let chid = "seqn_" + i + "_ch";
            oSeq += getMIDIChannelSelectorHTML( "seqn_" + i + "_ch", false, null );
            oSeq += "</td>";
            oSeq += "<td><input type='checkbox' id='seqn_" + i + "_int'></td>";
            oSeq += "<td><input type='checkbox' id='seqn_" + i + "_c'></td>";
            oSeq += "<td><input type='checkbox' id='seqn_" + i + "_a'></td>";
            oSeq += "<td><input type='checkbox' id='seqn_" + i + "_d'></td>";
            // let id = "seqn_" + i + "_clk";
            oSeq += "<td title='Sequencer " + (i + 1) + " external clock source'>";
            oSeq += "<select id='" + "seqn_" + i + "_clk" + "'>";
            oSeq += "<option value=0>External</option>";
            for ( let j=1; j<=16; ++j ) {
                oSeq += "<option value=" + j + ">Euclidean " + j + "</option>";
            }
            oSeq += "</select></td>";

            // TOOD: add
            // document.write( "<td colspan=8></td>" );

            oSeq += "</tr>";
        }
        document.write(oSeq);
    </script>
    <tr><th>Drum sequencers</th><th colspan=6></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr>
    <script>
        for ( let i=0; i<1; ++i ) {
            let cl = ( i & 1 ) ? "a" : "b";
            document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td><td>" );
            let chid = "seqd_" + i + "_ch";
            writeMIDIChannelSelector( chid, false, null );
            document.write( "</td>" );
            document.write( `<td><input type='checkbox' id='seqd_${i}_int'></td>` );
            document.write( `<td><input type='checkbox' id='seqd_${i}_c'></td>` );
            document.write( `<td><input type='checkbox' id='seqd_${i}_a'></td>` );
            document.write( `<td><input type='checkbox' id='seqd_${i}_d'></td>` );
            document.write( "<td></td>" );
            for ( let j=0; j<8; ++j ) {
                let id = "seqd_" + i + "_n_" + j;
                document.write( "<td>" );
                writeMIDICCSelector( id, false, false, false );
                document.write( "</td>" );
            }
            document.write( "</tr>" );
        }
    </script>
</table>


<table id="seqm_table"><caption class="hidden">Sequencer mappings</caption>
<tr>
<th>Sequencer mappings</th>
</tr>
<tr><td><table class='nested'>
<tr><td></td><th>Rate</th><th>Reset</th><th>Gate Length</th><th>Position</th></tr>
<tr><th>Note sequencers</th><th colspan=4>Channel/CC</th></tr>
<script>
	var seqControlLabels = [ "rate", "reset", "gate length" ];
	for ( let i=0; i<4; ++i ) {
		let cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );
		for ( let j=0; j<seqControls.length; ++j ) {
			let chid = "seq" + i + "_" + seqControls[j] + "_ch";
			let ccid = "seq" + i + "_" + seqControls[j] + "_cc";
			let param_label = seqControlLabels[j];
			document.write( "<td><label class='hidden' for='" + chid + "'>" + param_label + " MIDI channel (sequencer " + i + ")</label>");
			writeMIDIChannelSelector( chid, true, ccid );
			document.write( "<label class='hidden' for='" + ccid + "'>" + param_label + " MIDI CC (sequencer " + i + ")</label>");
			writeMIDICCSelector( ccid );
			document.write( "</td>" );
		}
		document.write( "</tr>" );
	}
</script>
</table></td></tr>
<tr><td><table class='nested'>
<tr><td></td><th colspan=2>Global</th>
<script>
    for ( let j=0; j<8; ++j ) {
    	document.write( "<th colspan=3>Lane " + (1+j) + "</th>" );
    }
</script>
<tr><th>Drum sequencers</th><th>Reset</th><th>Position</th>
<th>Rate</th><th>Reset</th><th>Position</th><th>Rate</th><th>Reset</th><th>Position</th><th>Rate</th><th>Reset</th><th>Position</th><th>Rate</th><th>Reset</th><th>Position</th><th>Rate</th><th>Reset</th><th>Position</th><th>Rate</th><th>Reset</th><th>Position</th><th>Rate</th><th>Reset</th><th>Position</th><th>Rate</th><th>Reset</th><th>Position</th>
</tr>
<script>
	var dseqControlLabels = [ "reset" ];
	var dseqlControlLabels = [ "rate", "reset" ];
	for ( let i=0; i<1; ++i ) {
		let cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );
		for ( let j=0; j<dseqControls.length; ++j ) {
			let chid = "dseq" + i + "_" + dseqControls[j] + "_ch";
			let ccid = "dseq" + i + "_" + dseqControls[j] + "_cc";
			let param_label = dseqControlLabels[j];
			document.write( "<td><label class='hidden' for='" + chid + "'>" + param_label + " MIDI channel (drum sequencer " + i + ")</label>");
			writeMIDIChannelSelector( chid, true, ccid );
			document.write( "<label class='hidden' for='" + ccid + "'>" + param_label + " MIDI CC (drum sequencer " + i + ")</label>");
			writeMIDICCSelector( ccid );
			document.write( "</td>" );
		}
		for ( let k=0; k<8; ++k ) {
			for ( let j=0; j<dseqlControls.length; ++j ) {
				let chid = "dseq" + i + "_" + k + "_" + dseqlControls[j] + "_ch";
				let ccid = "dseq" + i + "_" + k + "_" + dseqlControls[j] + "_cc";
				let param_label = dseqlControlLabels[j];
				document.write( "<td><label class='hidden' for='" + chid + "'>" + param_label + " MIDI channel (drum sequencer " + i + " lane " + k + ")</label>");
				writeMIDIChannelSelector( chid, true, ccid );
				document.write( "<label class='hidden' for='" + ccid + "'>" + param_label + " MIDI CC (drum sequencer " + i + " lane " + k + ")</label>");
				writeMIDICCSelector( ccid );
				document.write( "</td>" );
			}
		}
		document.write( "</tr>" );
	}
</script>
</table></td></tr>
</table>


<!-- CLOCKS -->
<table id="clk_table">
<tr>
<th colspan=7 class="bg-blue">Clocks</th>
</tr>
<tr><td></td><th>Output</th>
<th>Type</th><th>Base</th><th>Multiplier</th><th>Length</th><th>Shift</th>
</tr>
<script>
    let oClk = '';
	for ( i = 1; i < 33; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		oClk += `<tr class=${cl}><td>${i}</td>`;

		var clkid = "clk_" + i;

		id = clkid + "_output";
		oClk += `<td title='Output (Clock ${i})'>`;
		oClk += getGateChannelSelectorHTML( id, false );
		oClk += "</td>";

		id = clkid + "_type";
		oClk += `<td title='Type (Clock ${i})'>`;
		oClk += `<select onchange='changeClock("${clkid}")' id='${id}'>`;
		oClk += "<option value='0'>--</option><option value='1'>Clock</option><option value='2'>Run/Stop</option><option value='3'>Stop/Run</option><option value='4'>Start/Continue Trigger</option><option value='5'>Stop Trigger</option><option value='6'>Start/Continue/Stop Trigger</option><option value='7'>Start Only Trigger</option><option value='8'>Start/Stop Trigger</option>";
		oClk += "</select></td>";

		id = clkid + "_base";
		oClk += `<td title='Base (Clock ${i})'>`;
		oClk += "<select id='" + id + "' style='display:none'>";
		oClk += "<option value='96'>1/1</option><option value='48'>1/2</option><option value='24' selected>1/4</option><option value='16'>1/4T</option><option value='12'>1/8</option><option value='8'>1/8T</option><option value='6'>1/16</option><option value='4'>1/16T</option><option value='3'>1/32</option><option value='2'>1/32T</option><option value='1'>1/64T</option>";
		oClk += "</select></td>";
        //document.getElementById( id ).value = 24;

		id = clkid + "_mult";
		oClk += `<td title='Multiplier (Clock ${i})'>`;
		oClk += `<select id='${id}' style='display:none'>`;
        oClk += getOptionsHTML(1, 127, 0, 0);
		oClk += "</select></td>";

		id = clkid + "_len";
		oClk += `<td title='Length (Clock ${i})'>`;
		oClk += `<select id='${id}' style='display:none'><option value='0'>50% PW</option>`;
        oClk += getOptionsHTML(1, 127, 0);
		oClk += "</select></td>";

		id = clkid + "_shift";
		oClk += `<td title='Shift (Clock ${i})'>`;
		oClk += `<select id='${id}' style='display:none'>`;
		oClk += "<option value='0'>0</option><option value='96'>1/1</option><option value='84'>7/8</option><option value='72'>3/4</option><option value='48'>1/2</option><option value='24'>1/4</option><option value='16'>1/4T</option><option value='12'>1/8</option><option value='8'>1/8T</option><option value='6'>1/16</option><option value='4'>1/16T</option><option value='3'>1/32</option><option value='2'>1/32T</option><option value='1'>1/64T</option>";
		oClk += "</select></td>";

		// changeClock( clkid );
	}
    document.write(oClk);
</script>
</table>

<!-- TRIGGERS -->
<table id="trg_table">
<tr>
<th colspan=6 class="bg-blue">Triggers/Gates</th>
</tr>
<tr><td></td><th>Output</th>
<th>Type</th><th>Channel</th><th>Note</th><th>Envelope Settings</th>
</tr>
<script>
    let oTrig = '';
	for ( i = 1; i <= 64; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		oTrig += `<tr class=${cl}><td>${i}</td>`;

		var clkid = "trg_" + i;

		id = clkid + "_output";
		oTrig += `<td title='Output (Trigger ${i})'>`;
		oTrig += getGateChannelSelectorHTML( id, false );
		oTrig += "</td>";

		id = clkid + "_type";
		oTrig += `<td title='Type (Trigger ${i})'>`;
		oTrig += `<select onchange='changeTrigger("${clkid}")' id='${id}'>`;
		oTrig += "<option value='0'>--</option><option value='1'>Trigger</option><option value='2'>Gate</option><option value='3'>Velocity Trig</option><option value='4'>Velocity Gate</option><option value='5'>Accent Trig</option><option value='6'>Accent Gate</option><option value='7'>Toggle</option><option value='8'>On/off Trig</option><option value='9'>Envelope</option><option value='10'>Velocity</option>";
		oTrig += "</select></td>";
		id = clkid + "_ch";
		oTrig += `<td title='MIDI channel (Trigger ${i})'>`;
        oTrig += getMIDIChannelSelectorHTML( id, false, null, false );
		oTrig += "</td>";
		id = clkid + "_note";
		oTrig += `<td title='MIDI note (Trigger ${i})'>`;
        oTrig += getMIDICCSelectorHTML( id, true, null, false );
		oTrig += "</td>";
		id = clkid + "_env";
		oTrig += `<td title='Envelope settings (Trigger ${i})'>`;
        oTrig += getMIDIChannelSelectorHTML( id, false, null, true );
		oTrig += "</td>";
		// changeTrigger( clkid );
	}
    document.write(oTrig);
</script>
</table>

<!-- HID GAMEPAD -->
<table id="hid_table">
<tr>
<th colspan=5 class="bg-blue">HID Gamepad</th>
</tr>
<tr><td></td><th>Output</th><th>Usage</th>
<th>Scale</th><th>Offset</th>
</tr>
<script>
    let oPad = '';
	for ( i = 1; i < 33; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		oPad += `<tr class=${cl}><td>${i}</td>`;
		id = `hid_${i}_output`;
		oPad += `<td title='Output (GamePad ${i})'>`;
		oPad += getGateChannelSelectorHTML( id, true, i-1 );
		oPad += "</td>";
		// document.getElementById( id ).value = i-1;
		var usage_id = `hid_${i}_usage`;
		oPad += `<td title='Useage (GamePad ${i})'>`;
		oPad += `<select onchange='changeHidUsage("${usage_id}", ${i})' id='${usage_id}'>`;
		oPad += "<option value='0'>--</option><option value='20'>X</option><option value='21'>Y</option><option value='22'>Z</option>";
		oPad += "<option value='23'>Rx</option><option value='24'>Ry</option><option value='25'>Rz</option>";
		oPad += "<option value='26'>Slider</option><option value='27'>Dial</option><option value='28'>Wheel</option>";
		oPad += "<option value='29'>Hat</option><option value='30'>HatU</option><option value='31'>HatD</option>";
		oPad += "<option value='32'>HatL</option><option value='33'>HatR</option>";
		for ( j = 1; j < 20; ++j ) {
			oPad += `<option value='${j}'>Button${j}</option>`;
		}
		oPad += "</select></td>";

		id = `hid_${i}_scale`;
		oPad += `<td title='Scale (GamePad ${i})'>`;
		oPad += `<input onchange='changeHidScale("${id}")' type='text' id='${id}' min=-256 max=256 size=5 type='number' value='0' style='display: none'></td>`;

		id = `hid_${i}_offset`;
		oPad += `<td title='Offset (GamePad ${i})'>`;
		oPad += `<input onchange='changeHidOffset("${id}")' type='text' id='${id}' min=0 max=4096 size=5 type='number' value='0' style='display: none'></td>`;
		// changeHidUsage( usage_id, i );
	}
    document.write(oPad);
</script>
</table>

<!-- HID KEYBOARD -->
<table id="kbd_table">
<tr>
<th colspan=6 class="bg-blue">HID Keyboard</th>
</tr>
<tr><td></td><th>Output</th><th>Type</th><th>Key</th>
<th>Release</th><th>Press</th>
</tr>
<script>
	var kbdCodes = [ "","","","","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
					"1","2","3","4","5","6","7","8","9","0",
					"Return","Escape","Delete","Tab","Spacebar","Minus","Equal","[","]","\\","#",";","'","`",",",".","/","Caps Lock",
					"F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12",
					"Print","Scroll","Pause","Insert","Home","Page Up","Delete","End","Page Down","Right","Left","Down","Up",
					"Num Lock","Keypad /","Keypad *","Keypad -","Keypad +","Keypad Enter",
					"Keypad 1","Keypad 2","Keypad 3","Keypad 4","Keypad 5","Keypad 6","Keypad 7","Keypad 8","Keypad 9","Keypad 0",
					"Keypad ."
	];

    let kbdCodesOptions = '';
    for ( j = 0; j < kbdCodes.length; ++j ) {
        if ( kbdCodes[j] != "" ) {
            kbdCodesOptions += `<option value='${j}'>${kbdCodes[j]}</option>`;
        }
    }

    let oKbd = '';
	for ( i = 1; i < 33; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		oKbd += `<tr class=${cl}><td>${i}</td>`;
		id = `kbd_${i}_output`;
		oKbd += `<td title='Output (Keyboard ${i})'>`;
		oKbd += getGateChannelSelectorHTML( id, true, i-1 );
		oKbd += "</td>";
		// document.getElementById( id ).value = i-1;
		id = `kbd_${i}_type`;
		oKbd += `<td title='Type (Keyboard ${i})'>`;
		oKbd += `<select id='${id}'>`;
		oKbd += "<option value='0'>--</option><option value='1'>Press/Release</option><option value='2'>Press only</option>";
		oKbd += "</select></td>";
		id = `kbd_${i}_key`;
		oKbd += `<td title='Key (Keyboard ${i})'>`;
		oKbd += `<select id='${id}'>`;
        // let o = '';
		// for ( j = 0; j < kbdCodes.length; ++j ) {
		// 	if ( kbdCodes[j] != "" ) {
		// 		o += "<option value='" + j + "'>" + kbdCodes[j] + "</option>";
		// 	}
		// }
        // document.write(o);
        oKbd += kbdCodesOptions;
		oKbd += "</select></td>";
		id = `kbd_${i}_value0`;
		oKbd += `<td title='Value 0 (Keyboard ${i})'>`;
		oKbd += `<input onchange='changeGateLevel("${id}")' type='text' id='${id}' min=0 max=16383 size=5 type='number' value='0'></td>`;
		id = `kbd_${i}_value1`;
		oKbd += `<td title='Value 1 (Keyboard ${i})'>`;
		oKbd += `<input onchange='changeGateLevel("${id}")' type='text' id='${id}' min=0 max=16383 size=5 type='number' value='16383'></td>`;
	}
    document.write(oKbd);
</script>
</table>

<!-- CV/MIDI -->
<table id="cvm_table">
<tr><th colspan=7 class="bg-blue">CV/MIDI</th><th colspan=4>Output to</th></tr>
<tr>
<th></th><th>Enable</th><th>Type</th><th>Channel</th><th>CC or Note</th><th>0V</th><th>5V</th>
<th>Internal</th><th>USB A</th><th>USB C</th><th>DIN</th>
</tr>
<script>
	var cvms = [ 'X', 'Y' ];
	for ( var i=0; i<2; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + cvms[i] + "</td>" );
		var id = "cvm_en_" + i;
		document.write( "<td title='Enable (Input " + cvms[i] + ")'>");
		document.write( "<input type='checkbox' id='" + id + "'></td>" );
		var id = "cvm_type_" + i;
		document.write( "<td title='Type (Input " + cvms[i] + ")'>");
		document.write( "<select id='" + id + "'><option value=0>CC</option><option value=1>Trigger</option><option value=2>Note</option><option value=3>Program change</option><option value=4>Aftertouch</option></select>" );
		var chid = "cvm_ch_" + i;
		var ccid = "cvm_cc_" + i;
		document.write( "<td title='MIDI channel (Input " + cvms[i] + ")'>");
		writeMIDIChannelSelector( chid, false, ccid );
		document.write( "</td>");

		document.write( "<td title='MIDI CC (Input " + cvms[i] + ")'>");
		writeMIDICCSelector( ccid, false, false );
		document.write( "</td>" );

		var id = "cvm_0v_" + i;
		document.write( "<td title='0V Level (Input " + cvms[i] + ")'>");
		document.write( "<input onchange='changeCVMLevel(\"" + id + "\")' type='text' id='" + id + "' min=-16383 max=16383 size=5 type='number' value='0'></td>" );

		var id = "cvm_5v_" + i;
		document.write( "<td title='5V Level (Input " + cvms[i] + ")'>");
		document.write( "<input onchange='changeCVMLevel(\"" + id + "\")' type='text' id='" + id + "' min=-16383 max=16383 size=5 type='number' value='0'></td>" );

		var id = "cvm_outI_" + i;
		document.write( "<td title='Output to Internal (Input " + cvms[i] + ")'>");
		document.write( "<input type='checkbox' id='" + id + "'></td>" );

		var id = "cvm_outA_" + i;
		document.write( "<td title='Output to USB A (Input " + cvms[i] + ")'>");
		document.write( "<input type='checkbox' id='" + id + "'></td>" );

		var id = "cvm_outC_" + i;
		document.write( "<td title='Output to USB C (Input " + cvms[i] + ")'>");
		document.write( "<input type='checkbox' id='" + id + "'></td>" );

		var id = "cvm_outD_" + i;
		document.write( "<td title='Output to DIN (Input " + cvms[i] + ")'>");
		document.write( "<input type='checkbox' id='" + id + "'></td>" );
		document.write( "</tr>" );
	}
</script>
</table>

<script>
showHide( "glb_table", false );
showHide( "env_table", false );
showHide( "arp_table", false );
showHide( "clk_table", false );
showHide( "trg_table", false );
showHide( "euc_table", false );
showHide( "srr_table", false );
showHide( "seq_table", false );
showHide( "seqm_table", false );
showHide( "hid_table", false );
showHide( "kbd_table", false );
showHide( "cvm_table", false );
</script>

<script>
/* CONFIG */
function parseMcv( data, c, m ) {
	// enable
	document.getElementById( "mcv_enable_" + m ).checked = data[c];	c += 1;
	// channel
	var ch = data[c]; c += 1;
	if ( ch >= 0 && ch <= 15 ) {
		document.getElementById( "mcv_ch_" + m ).value = ch+1;
	}
	// min/max
	var r = data[c]; c += 1;
	if ( r >= 0 && r <= 127 ) {
		document.getElementById( "mcv_min_" + m ).value = r;
	}
	var r = data[c]; c += 1;
	if ( r >= 0 && r <= 127 ) {
		document.getElementById( "mcv_max_" + m ).value = r;
	}
	// type
	var r = data[c]; c += 1;
	document.getElementById( "mcv_type_" + m ).value = r;
	// polyphony
	var r = data[c]; c += 1;
	if ( r >= 1 && r <= 16 ) {
		document.getElementById( "mcv_voices_" + m ).value = r;
	}
	// bend depth
	document.getElementById( "mcv_bend_" + m ).value = data[c];	c += 1;
	// voice allocation scheme
    document.getElementById( "mcv_scheme_" + m ).value = data[c];	c += 1;
	// ignore surplus
	document.getElementById( "mcv_stealing_" + m ).checked = data[c];	c += 1;
	// gated pressure
	document.getElementById( "mcv_GA_" + m ).checked = data[c];	c += 1;
	// sustain
	document.getElementById( "mcv_SUS_" + m ).value = data[c];	c += 1;
	// base output
	var r = data[c]; c += 1;
	if ( r >= 0 && r <= 63 ) {
		document.getElementById( "mcv_base_" + m ).value = r;
	}
	// stride
	var r = data[c]; c += 1;
	if ( r >= 1 && r <= 32 ) {
		document.getElementById( "mcv_stride_" + m ).value = r;
	}
	// last MPE
	document.getElementById( "mcv_lastMPE_" + m ).value = data[c]+1;	c += 1;
	// pressure
	document.getElementById( "mcv_A_" + m ).checked = data[c];	c += 1;
	// para gate
	document.getElementById( "mcv_G_" + m ).checked = data[c];	c += 1;
	// cv output
	document.getElementById( "mcv_VC_" + m ).checked = data[c];	c += 1;
	// gate output
	document.getElementById( "mcv_VG_" + m ).checked = data[c];	c += 1;
	// vel gate output
	document.getElementById( "mcv_VVG_" + m ).checked = data[c];	c += 1;
	// vel output
	document.getElementById( "mcv_VV_" + m ).value = data[c];	c += 1;
	// rel vel output
	document.getElementById( "mcv_VR_" + m ).value = data[c];	c += 1;
	// trigger output
	document.getElementById( "mcv_VT_" + m ).checked = data[c];	c += 1;
	// voice pressure output
	document.getElementById( "mcv_VP_" + m ).checked = data[c];	c += 1;
	// MPE Y output/CC
	document.getElementById( "mcv_VY_" + m ).value = data[c];	c += 1;
	// envelope output
	document.getElementById( "mcv_VE_" + m ).checked = data[c];	c += 1;
	// base gate output
	var r = data[c]; c += 1;
	if ( r < 64 || r > 127 ) {
		r = 0;
	}
	document.getElementById( "mcv_basegate_" + m ).value = r;
	// mono retrigger
	document.getElementById( "mcv_MT_" + m ).checked = data[c];	c += 1;
	// interrupt gate
	document.getElementById( "mcv_IG_" + m ).checked = data[c];	c += 1;
	// env zero start
	document.getElementById( "mcv_ZS_" + m ).checked = data[c];	c += 1;
	// bend down depth
	document.getElementById( "mcv_benddown_" + m ).value = data[c];	c += 1;
	// pitch bend output
	document.getElementById( "mcv_PB_" + m ).value = data[c];	c += 1;
	// random output
	document.getElementById( "mcv_VRND_" + m ).checked = data[c];	c += 1;

	changeType( m );
}
function parseConfigDump( data ) {
	var c = 0;
	// version
	var version = ( data[c] ) | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 )
	if ( version != 11 )
	{
		alert( "This version of the tool does not match the FH-2 firmware." );
		return;
	}
	c += 4;
	// name
	var name = "";
	for ( var i = 0; i < 16; ++i ) {
		var n = data[c+i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
	document.getElementById( "config_name" ).value = name;

    updateConfigurationSelector(name);

	c += 17;
	// globals
	document.getElementById( "glb_triglen" ).value = data[c];		 c += 1;
	document.getElementById( "glb_transpose" ).value = unSysexSafeSignedChar( data[c] );		 c += 1;
	document.getElementById( "glb_legvel" ).checked = data[c];		 c += 1;
	document.getElementById( "glb_extclkmult" ).value = data[c];		 c += 1;
	document.getElementById( "glb_extclkrun" ).value = data[c];		 c += 1;
	document.getElementById( "glb_presetprogch" ).value = data[c];		 c += 1;
	document.getElementById( "glb_softtakeover" ).checked = data[c];		 c += 1;
	// output ranges
	for ( var i = 1; i < 65; ++i ) {
		document.getElementById( "rng_" + i ).value = data[c];
        setRangeColor( "rng_" + i );
        c += 1;
    }
	// mcvs
	for ( var i = 0; i < 16; ++i ) {
		parseMcv( data, c, i+1 );
		c += 32;
	}
	// mappings
	for ( j=0; j<ac.length; ++j ) {
		for ( i = 0; i < 64; ++i ) {
			var ccid = "out_" + ac[j] + "_cc_" + i;
			document.getElementById( "out_" + ac[j] + "_ch_" + i ).value = -1;
			var ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
	}
	for ( j=1; j<17; ++j ) {
		var id = "arpeg" + j + "_";
		for ( i = 0; i < arpControls.length; ++i ) {
			var ccid = id + arpControls[i] + "_cc";
			document.getElementById( id + arpControls[i] + "_ch" ).value = -1;
			var ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
		var id = "mcvcom" + j + "_";
		for ( i = 0; i < mcvCommands.length; ++i ) {
			var ccid = id + mcvCommands[i] + "_cc";
			document.getElementById( id + mcvCommands[i] + "_ch" ).value = -1;
			var ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
		var id = "mcvm2_" + j + "_";
		for ( i = 0; i < mcvMappable2Controls.length; ++i ) {
			var ccid = id + mcvMappable2Controls[i] + "_cc";
			document.getElementById( id + mcvMappable2Controls[i] + "_ch" ).value = -1;
			var ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
	}
	for ( j=1; j<17; ++j ) {
		var id = "euc_" + j + "_";
		for ( i = 0; i < eucControls.length; ++i ) {
			var ccid = id + eucControls[i] + "_cc";
			document.getElementById( id + eucControls[i] + "_ch" ).value = -1;
			var ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
	}
/*
			document.getElementById( "glb_tempo_ch" ).value = -1;
			var ta = document.getElementById( "glb_tempo_cc" );
			ta.value = -1;
			ta.style.display = "none";
			document.getElementById( "dispmode_ch" ).value = -1;
			var ta = document.getElementById( "dispmode_cc" );
			ta.value = -1;
			ta.style.display = "none";
			document.getElementById( "dispitem_ch" ).value = -1;
			var ta = document.getElementById( "dispitem_cc" );
			ta.value = -1;
			ta.style.display = "none";
			document.getElementById( "glb_swing_type_ch" ).value = -1;
			var ta = document.getElementById( "glb_swing_type_cc" );
			ta.value = -1;
			ta.style.display = "none";
			document.getElementById( "glb_swing_amount_ch" ).value = -1;
			var ta = document.getElementById( "glb_swing_amount_cc" );
			ta.value = -1;
			ta.style.display = "none";
*/
	for ( j=1; j<17; ++j ) {
		var id = "srr_" + j + "_";
		for ( i = 0; i < srrControls.length; ++i ) {
			var ccid = id + srrControls[i] + "_cc";
			document.getElementById( id + srrControls[i] + "_ch" ).value = -1;
			var ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
	}
	for ( j=0; j<4; ++j ) {
		let id = "seq" + j + "_";
		for ( i = 0; i < seqControls.length; ++i ) {
			let ccid = id + seqControls[i] + "_cc";
			document.getElementById( id + seqControls[i] + "_ch" ).value = -1;
			let ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
	}
	for ( j=0; j<1; ++j ) {
		let id = "dseq" + j + "_";
		for ( i = 0; i < dseqControls.length; ++i ) {
			let ccid = id + dseqControls[i] + "_cc";
			document.getElementById( id + dseqControls[i] + "_ch" ).value = -1;
			let ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
	}
	for ( j=0; j<8; ++j ) {
		let id = "dseq0_" + j + "_";
		for ( i = 0; i < dseqlControls.length; ++i ) {
			let ccid = id + dseqlControls[i] + "_cc";
			document.getElementById( id + dseqlControls[i] + "_ch" ).value = -1;
			let ta = document.getElementById( ccid );
			ta.value = -1;
			ta.style.display = "none";
		}
	}
	for ( j=0; j<global_mappable.length; ++j ) {
		document.getElementById( global_mappable[j] + "_ch" ).value = -1;
		var ta = document.getElementById( global_mappable[j] + "_cc" );
		ta.value = -1;
		ta.style.display = "none";
	}



	for ( var i = 0; i < 384; ++i ) {
		var ch = data[c+0];
		var cc = data[c+1];
		var t0 = data[c+2];
		var t1 = data[c+3];
		if ( ( ch >> 4 ) == 3 ) {
			ch = ch & 0xf;
			let relative = ( t0 & 32 ) != 0;
			t0 = t0 & ~32;
			let ccid = "";
			if ( t0 <= 8 ) {
				var aci = acMapLow[t0];
				if ( t1 >= 64 ) {
					t1 -= 64;
					aci = acMapHigh[t0];
				}
				if ( aci >= 0 ) {
					if ( t1 >= 0 && t1 < 64 ) {
						var id = "out_" + ac[aci] + "_ch_" + t1;
						ccid = "out_" + ac[aci] + "_cc_" + t1;
						document.getElementById( id ).value = ch+1;
						document.getElementById( ccid ).value = cc;
						changeMIDIChannel( id, ccid );
					}
				}
			}
			else {		// t0 > 8
				if ( t0 == 9 ) {
					var j = ( t1 >> 3 ) + 1;
					var k = t1 & 7;
					if ( k >= 0 && k < arpControls.length ) {
						var id = "arpeg" + j + "_";
						ccid = id + arpControls[k] + "_cc";
						id = id + arpControls[k] + "_ch";
						document.getElementById( id ).value = ch+1;
						document.getElementById( ccid ).value = cc;
						changeMIDIChannel( id, ccid );
					}
				}
				else if ( t0 == 10 ) {
					var j = ( t1 >> 3 ) + 1;
					var k = t1 & 7;
					if ( k >= 0 && k < eucControls.length ) {
						var id = "euc_" + j + "_";
						ccid = id + eucControls[k] + "_cc";
						id = id + eucControls[k] + "_ch";
						document.getElementById( id ).value = ch+1;
						document.getElementById( ccid ).value = cc;
						changeMIDIChannel( id, ccid );
					}
				}
				else if ( t0 == 11 ) {
					var j = ( t1 >> 3 ) + 1;
					var k = t1 & 7;
					if ( k >= 0 && k < mcvCommands.length ) {
						var id = "mcvcom" + j + "_";
						ccid = id + mcvCommands[k] + "_cc";
						id = id + mcvCommands[k] + "_ch";
						document.getElementById( id ).value = ch+1;
						document.getElementById( ccid ).value = cc;
						changeMIDIChannel( id, ccid );
					}
				}
				else if ( t0 == 12 ) {
					var j = ( t1 >> 3 ) + 1;
					var k = t1 & 7;
					if ( k >= 0 && k < mcvMappable2Controls.length ) {
						var id = "mcvm2_" + j + "_";
						ccid = id + mcvMappable2Controls[k] + "_cc";
						id = id + mcvMappable2Controls[k] + "_ch";
						document.getElementById( id ).value = ch+1;
						document.getElementById( ccid ).value = cc;
						changeMIDIChannel( id, ccid );
					}
				}
				else if ( t0 == 13 ) {
					let j = ( t1 >> 4 );
					let k = t1 & 0xf;
					if ( j < 4 ) {
						if ( k >= 0 && k < seqControls.length ) {
							let id = "seq" + j + "_";
							ccid = id + seqControls[k] + "_cc";
							id = id + seqControls[k] + "_ch";
							document.getElementById( id ).value = ch+1;
							document.getElementById( ccid ).value = cc;
							changeMIDIChannel( id, ccid );
						}
					}
					else {
						j -= 4;
						if ( k >= 0 && k < dseqControls.length ) {
							let id = "dseq" + j + "_";
							ccid = id + dseqControls[k] + "_cc";
							id = id + dseqControls[k] + "_ch";
							document.getElementById( id ).value = ch+1;
							document.getElementById( ccid ).value = cc;
							changeMIDIChannel( id, ccid );
						}
					}
				}
				else if ( t0 == 14 ) {
					let j = ( t1 >> 4 );
					let k = t1 & 0xf;
					if ( k >= 0 && k < dseqlControls.length ) {
						let id = "dseq0_" + j + "_";
						ccid = id + dseqlControls[k] + "_cc";
						id = id + dseqlControls[k] + "_ch";
						document.getElementById( id ).value = ch+1;
						document.getElementById( ccid ).value = cc;
						changeMIDIChannel( id, ccid );
					}
				}
				else if ( t0 == 15 ) {
					var j = ( t1 >> 3 ) + 1;
					var k = t1 & 7;
					if ( k >= 0 && k < srrControls.length ) {
						var id = "srr_" + j + "_";
						ccid = id + srrControls[k] + "_cc";
						id = id + srrControls[k] + "_ch";
						document.getElementById( id ).value = ch+1;
						document.getElementById( ccid ).value = cc;
						changeMIDIChannel( id, ccid );
					}
				}
				else if ( t0 == 69 ) {
					var id = "glb_tempo_ch";
					ccid = "glb_tempo_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 71 ) {
					var id = "dispmode_ch";
					ccid = "dispmode_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 72 ) {
					var id = "dispitem_ch";
					ccid = "dispitem_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 74 ) {
					var id = "glb_swing_type_ch";
					ccid = "glb_swing_type_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 75 ) {
					var id = "glb_swing_amount_ch";
					ccid = "glb_swing_amount_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 76 ) {
					var id = "nudgefaster_ch";
					ccid = "nudgefaster_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 77 ) {
					var id = "nudgeslower_ch";
					ccid = "nudgeslower_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 78 ) {
					var id = "inctempo_ch";
					ccid = "inctempo_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
				else if ( t0 == 79 ) {
					var id = "dectempo_ch";
					ccid = "dectempo_cc";
					document.getElementById( id ).value = ch+1;
					document.getElementById( ccid ).value = cc;
					changeMIDIChannel( id, ccid );
				}
			}
			if ( ccid != "" ) {
				let rel = document.getElementById( ccid + "_rel" );
				if ( rel != null ) {
					rel.checked = relative;
				}
			}
		}
		c += 4;
	}
	// clocks
	for ( var i = 1; i < 33; ++i ) {
		var clkid = "clk_" + i;
		document.getElementById( clkid + "_type" ).value = data[c+0];
		document.getElementById( clkid + "_base" ).value = data[c+1];
		document.getElementById( clkid + "_mult" ).value = data[c+2];
		document.getElementById( clkid + "_len" ).value = data[c+3];
		document.getElementById( clkid + "_output" ).value = data[c+4];
		document.getElementById( clkid + "_shift" ).value = data[c+5];
		changeClock( clkid );
		c += 8;
	}
	// gate levels
	for ( var i = 0; i < 64; ++i ) {
		var gtid = "out_gt_" + i;
		var v = unSysexSafeShort( data[c+0] | ( data[c+1] << 8 ) );
		document.getElementById( gtid + "_lo" ).value = v;
		var v = unSysexSafeShort( data[c+2] | ( data[c+3] << 8 ) );
		document.getElementById( gtid + "_hi" ).value = v;
		c += 4;
	}
	// triggers
	for ( var i = 1; i <= 64; ++i ) {
		var clkid = "trg_" + i;
		let anyNote = ( ( data[c+1] >> 5 ) & 1 );
		document.getElementById( clkid + "_type" ).value = data[c+0] & 0xf;
		document.getElementById( clkid + "_ch" ).value = ( data[c+1] & 0xf ) + 1;
		document.getElementById( clkid + "_note" ).value = anyNote ? -1 : data[c+2];
		document.getElementById( clkid + "_output" ).value = data[c+3];
		document.getElementById( clkid + "_env" ).value = ( ( ( data[c+0] >> 4 ) << 1 ) | ( ( data[c+1] >> 4 ) & 1 ) ) + 1;
		changeTrigger( clkid );
		c += 4;
	}
	// euclidean outputs
	for ( var i = 1; i < 17; ++i ) {
		document.getElementById( "euc_output_" + i ).value = data[c];
		c += 1;
	}
	// globals
	document.getElementById( "glb_taptype" ).value = data[c];		 c += 1;
	document.getElementById( "glb_tapch" ).value = data[c];		 	 c += 1;
	document.getElementById( "glb_tapcc" ).value = data[c];		 	 c += 1;
	document.getElementById( "glb_eucaccent" ).value = data[c];		 c += 1;
	document.getElementById( "glb_starttype" ).value = data[c];		 c += 1;
	document.getElementById( "glb_startch" ).value = data[c];		 c += 1;
	document.getElementById( "glb_startcc" ).value = data[c];		 c += 1;
	c += 1;
	changeStartStop();
	// euclidean off outputs
	for ( var i = 1; i < 17; ++i ) {
		document.getElementById( "euc_offoutput_" + i ).value = data[c];
		c += 1;
	}
	// gamepad mappings
	for ( var i = 1; i < 33; ++i ) {
		var gtid = "hid_" + i;
		var usage_id = gtid + "_usage";
		document.getElementById( usage_id ).value = data[c+0];
		document.getElementById( gtid + "_output" ).value = data[c+1];
		var v = unSysexSafeSignedShort( data[c+2] | ( data[c+3] << 8 ) );
		document.getElementById( gtid + "_scale" ).value = v;
		var v = unSysexSafeSignedShort( data[c+4] | ( data[c+5] << 8 ) );
		document.getElementById( gtid + "_offset" ).value = v;
		changeHidUsage( usage_id, i );
		c += 8;
	}
	// keyboard mappings
	for ( var i = 1; i < 33; ++i ) {
		var gtid = "kbd_" + i;
		document.getElementById( gtid + "_type" ).value = data[c+0];
		document.getElementById( gtid + "_output" ).value = data[c+1];
		document.getElementById( gtid + "_key" ).value = data[c+2];
		var v = unSysexSafeShort( data[c+4] | ( data[c+5] << 8 ) );
		document.getElementById( gtid + "_value0" ).value = v;
		var v = unSysexSafeShort( data[c+6] | ( data[c+7] << 8 ) );
		document.getElementById( gtid + "_value1" ).value = v;
		c += 8;
	}
	// lfo resets
	for ( var i = 1; i < 65; ++i ) {
		document.getElementById( "lfotrig_type_" + i ).value = data[c+0] >> 4;
		document.getElementById( "lfotrig_ch_" + i ).value = data[c+0] & 0xf;
		document.getElementById( "lfotrig_cc_" + i ).value = data[c+1];
		changeLfoReset( i );
		c += 2;
	}
	// cv/midi
	for ( var i = 0; i < 2; ++i ) {
		var t = data[c+0];
		document.getElementById( "cvm_en_" + i ).checked = ( t & ( 1<<0 ) ) != 0;
		document.getElementById( "cvm_outI_" + i ).checked = ( t & ( 1<<1 ) ) != 0;
		document.getElementById( "cvm_outA_" + i ).checked = ( t & ( 1<<2 ) ) != 0;
		document.getElementById( "cvm_outC_" + i ).checked = ( t & ( 1<<3 ) ) != 0;
		document.getElementById( "cvm_outD_" + i ).checked = ( t & ( 1<<4 ) ) != 0;
		document.getElementById( "cvm_type_" + i ).value = data[c+1] >> 4;
		document.getElementById( "cvm_ch_" + i ).value = ( data[c+1] & 0xf ) + 1;
		document.getElementById( "cvm_cc_" + i ).value = data[c+2];
		var v = unSysexSafeSignedShort( data[c+4] | ( data[c+5] << 8 ) );
		document.getElementById( "cvm_0v_" + i ).value = v;
		var v = unSysexSafeSignedShort( data[c+6] | ( data[c+7] << 8 ) );
		document.getElementById( "cvm_5v_" + i ).value = v;
		c += 8;
	}
	// globals
	document.getElementById( "glb_tempo_min" ).value = data[c];		 c += 1;
	document.getElementById( "glb_tempo_max" ).value = data[c];		 c += 1;
	c += 2;
	// sequencers
	for ( let i=0; i<4; ++i ) {
		document.getElementById( "seqn_" + i + "_ch" ).value = data[c]+1;	c += 1;
		let outs = data[c];													c += 1;
		document.getElementById( "seqn_" + i + "_int" ).checked = ( outs >> 0 ) & 1;
		document.getElementById( "seqn_" + i + "_c" ).checked = ( outs >> 1 ) & 1;
		document.getElementById( "seqn_" + i + "_a" ).checked = ( outs >> 2 ) & 1;
		document.getElementById( "seqn_" + i + "_d" ).checked = ( outs >> 3 ) & 1;
		document.getElementById( "seqn_" + i + "_clk" ).value = data[c];	c += 1;
		c += 1;
	}
	for ( let i=0; i<1; ++i ) {
		document.getElementById( "seqd_" + i + "_ch" ).value = data[c]+1;	c += 1;
		let outs = data[c];													c += 1;
		document.getElementById( "seqd_" + i + "_int" ).checked = ( outs >> 0 ) & 1;
		document.getElementById( "seqd_" + i + "_c" ).checked = ( outs >> 1 ) & 1;
		document.getElementById( "seqd_" + i + "_a" ).checked = ( outs >> 2 ) & 1;
		document.getElementById( "seqd_" + i + "_d" ).checked = ( outs >> 3 ) & 1;
		c += 2;
		for ( let j=0; j<8; ++j ) {
			document.getElementById( "seqd_" + i + "_n_" + j ).value = data[c];	c += 1;
		}
	}
	// mcv2
	for ( let i=1; i<=16; ++i ) {
		document.getElementById( "arp_" + i + "_clk" ).value = data[c];	c += 1;
		let m = data[c];	c += 1;
		document.getElementById( "arp_out_" + i + "_ch" ).value = 1 + ( m & 0xf );
		document.getElementById( "arp_out_" + i + "_c" ).checked = ( m >> 4 ) & 1;
		document.getElementById( "arp_out_" + i + "_a" ).checked = ( m >> 5 ) & 1;
		document.getElementById( "arp_out_" + i + "_d" ).checked = ( m >> 6 ) & 1;
		c += 2;
	}
	// srr outputs
	for ( var i = 1; i < 17; ++i ) {
		document.getElementById( "srr_output_" + i ).value = data[c] - 1;	c += 1;
		document.getElementById( "srr_change_" + i ).value = data[c];		c += 1;
		document.getElementById( "srr_trigger_" + i ).value = data[c];		c += 1;
		document.getElementById( "srr_clk_" + i ).value = data[c];			c += 1;
		let v = data[c];													c += 1;
		document.getElementById( "srr_nch_" + i ).value = v > 0 ? v : -1;
		document.getElementById( "srr_ch_" + i ).value = data[c]+1;			c += 1;
		let outs = data[c];													c += 1;
		document.getElementById( "srr_int_" + i ).checked = ( outs >> 0 ) & 1;
		document.getElementById( "srr_c_" + i ).checked = ( outs >> 1 ) & 1;
		document.getElementById( "srr_a_" + i ).checked = ( outs >> 2 ) & 1;
		document.getElementById( "srr_d_" + i ).checked = ( outs >> 3 ) & 1;
	}

	// skip to addendum
	c = 4096;
	for ( var i = 1; i < 17; ++i ) {
		if ( data[c] ) {
			document.getElementById( "euc_output_" + i ).value = -1;
		}
		c += 1;
	}
	for ( var i = 1; i < 17; ++i ) {
		if ( data[c] ) {
			document.getElementById( "euc_offoutput_" + i ).value = -1;
		}
		c += 1;
	}
	for ( var i = 1; i < 17; ++i ) {
        if (data[c] & 1) {
            document.getElementById("srr_change_" + i).value = -1;
        }
        if (data[c] & 2) {
            document.getElementById("srr_trigger_" + i).value = -1;
        }
        c += 1;
    }
}

function parseConfigName( data ) {

    // var str = String.fromCharCode.apply( null, data.slice( 6, -1 ) );
    // document.getElementById( "rxSysex" ).value += ( "\n-----\n" + str );

    // let name = String.fromCharCode.apply( null, data.slice( 6, -1 ) );


    // var c = 0;
    // // version
    // var version = ( data[c] ) | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 )
    // if ( version != 10 )
    // {
    //     alert( "This version of the tool does not match the FH-2 firmware." );
    //     return;
    // }
    // c += 4;
    // // name
    var name = "";
    for ( var i = 0; i < 16; ++i ) {
        var n = data[i];
        if ( n == 0 ) {
            break;
        }
        name += String.fromCharCode( n );
    }
    document.getElementById( "config_name" ).value = name;

    updateConfigurationSelector(name);
}

</script>

<script>
/* MIDI */

// local storage :
var fh2MIDIOutKey = "fh2-custom-midi-out"
var fh2MIDIInKey = "fh2-custom-midi-in"

var fh2OutPortId = null;
var fh2InPortId = null;

var midi, data;

const RECEIVED_NONE = 0;
const RECEIVED_VERSION = 1;
const RECEIVED_CONFIG_NAME = 2;
const RECEIVED_CONFIG_DUMP = 3;
const RECEIVED_UNKNOWN = 10;
var last_received_message = RECEIVED_NONE;

function setMidiInSelect(value) {
    document.getElementById( "midiinput" ).value = value;
}

function setMidiOutSelect(value) {
    document.getElementById( "midioutput" ).value = value;
}

function onMIDISuccess(midiAccess) {
	log( "midi access granted" );
    status("OK");
    midi = midiAccess;
    midi.onstatechange = onStateChange;
    onStateChange(null);
}
function onStateChange(e) {

    var str = "";
    // var fh2 = -1;
    var inputs = midi.inputs.values();
    for ( var input = inputs.next(); input && !input.done; input = inputs.next() ) {
	    str += "<option value='" + input.value.id + "'>" + input.value.name + "</option>";
	    // if ( input.value.name == "FH-2" ) {
		//     fh2 = input.value.id;
	    // }
    }
    document.getElementById( "midiinput" ).innerHTML = str;
    fh2InPortId = localStorage.getItem(fh2MIDIInKey);
    if (fh2InPortId) setMidiInSelect(fh2InPortId);

    // if ( fh2 != -1 ) {
	//     setMidiInSelect(fh2);
    // }
    str = "";
    // fh2 = -1;
    var outputs = midi.outputs.values();
    for ( var output = outputs.next(); output && !output.done; output = outputs.next() ) {
	    str += "<option value='" + output.value.id + "'>" + output.value.name + "</option>";
	    // if ( output.value.name == "FH-2" ) {
		//     fh2 = output.value.id;
	    // }
    }
    document.getElementById( "midioutput" ).innerHTML = str;
    fh2OutPortId = localStorage.getItem(fh2MIDIOutKey);
    if (fh2OutPortId) setMidiOutSelect(fh2OutPortId);
    // if ( fh2 != -1 ) {
    //     console.log("onStateChange set midioutput", fh2);
	//     setMidiOutSelect(fh2);
    // }

	changeInput();
}
function onMIDIFailure(e) {
	log( "midi access failure" );
    status("No access to MIDI devices or your browser doesn't support WebMIDI API.");
}
function setup_onmidimessage() {
    let inputs = midi.inputs.values();
    if ( inputs.size == 0 ) {
    	return;
    }
    for ( let input = inputs.next(); input && !input.done; input = inputs.next() ) {
    	input.value.onmidimessage = null;
    }
    let id = document.getElementById( "midiinput" ).value;
	let input = midi.inputs.get(id);
	if (input) {
        input.onmidimessage = onMIDIMessage;
    } else {
        console.log("input not found", id);
    }
}
function changeInput() {
  	setup_onmidimessage();
    let id = document.getElementById( "midiinput" ).value;
    if (id) {
        localStorage.setItem(fh2MIDIInKey, id);
    }
}
function changeOutput() {
    var id = document.getElementById( "midioutput" ).value;
    if (id) {
        localStorage.setItem(fh2MIDIOutKey, id);
    }
}
function onMIDIMessage(message) {
    data = message.data;
    var header = [ 0xF0, 0, 33, 39, 47 ];
    for ( var i=0; i<5; ++i ) {
    	if ( header[i] !== data[i] ) {
            if (data[i] === 248) {
                noop()
            } else {
                console.warn("onMIDIMessage: invalid header",  header[i], data[i]);
            }
    		return;
    	}
    }
    console.log("received message")
	var dd = log( "received sysex (" + data.length + " bytes)" );
	dumpSysex( data, "rxSysex", dd+"\n" );
	if ( data[5] == 0x32 && data.length > 7 ) {
		// version string
        last_received_message = RECEIVED_VERSION;
        // F0 00 21 27 2F 32 <NULL terminated ASCII string> F7
	    var str = String.fromCharCode.apply( null, data.slice( 6, -1 ) );
		document.getElementById( "rxSysex" ).value += ( "\n-----\n" + str );
	}
	else if ( data[5] == 0x10 ) {
		// config dump
        last_received_message = RECEIVED_CONFIG_DUMP;
        // F0 00 21 27 2F 10 00 00 <configuration data> F7
		parseConfigDump( data.slice( 8, -1 ) );
	}
	else if ( data[5] == 0x49 && data.length > 22 ) {
		// config name
        last_received_message = RECEIVED_CONFIG_NAME;
        // F0 00 21 27 2F 49 <ASCII string> F7
		parseConfigName( data.slice( 6, 6+16 ) );
	} else {
        last_received_message = RECEIVED_UNKNOWN;
    }
}
async function sendWithConfirmation() {
    if (window.confirm("Overwrite FH-2 current configuration?")) {

        // let slot = parseInt(document.getElementById("configurationSlot").value);
        // if (slot < 0) return;

        // console.log("sendWithConfirmation slot", slot)

        // let channel = parseInt(document.getElementById("configurationChannelSelector").value);

        // console.log("sendWithConfirmation channel", channel)

        // var arr = [0xC0 + (0x0F & channel), 0x7F & slot];
        // console.log("send", arr)
       	// var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
        // output.send(arr);
        // await wait(50)

        send();
    }
}
function send() {
	// var str = makeSysEx();
	// var arr = new Uint8Array( str.length );
	// for ( var i=0; i<str.length; ++i ) {
	// 	arr[i] = str.charCodeAt( i );
	// }
	let arr = makeSysEx();
	var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	output.send( arr );
	var dd = log( "sent sysex (" + arr.length + " bytes)" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function sendMsg() {
	var str = makeMsgSysEx();
	var arr = new Uint8Array( str.length );
	for ( var i=0; i<str.length; ++i ) {
		arr[i] = str.charCodeAt( i );
	}
	var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	output.send( arr );
	var dd = log( "sent sysex (" + str.length + " bytes)" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function request() {
	var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x2F, 0x21, 0xF7 ];
	output.send( arr );
	var dd = log( "sent config dump request to FH-2" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function reqVersion() {
	var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x2F, 0x22, 0xF7 ];
	output.send( arr );
	var dd = log( "sent version request to FH-2" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function requestConfigurationName() {
    var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
    var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x2F, 0x49, 0xF7 ];
    output.send( arr );
    var dd = log( "sent config name request to FH-2" );
    dumpSysex( arr, "txSysex", dd+"\n" );
}
if ( navigator.requestMIDIAccess ) {
    navigator.requestMIDIAccess ( {
        sysex: true
    } ).then(onMIDISuccess, onMIDIFailure);
} else {
    status("No MIDI support in your browser.");
}

//-----------------------------------------------------------------------------
// Import / Export :

// function encodedStr(s){
//     return s.replace(/[\u00A0-\u9999<>\&]/g, function(i) {
//         return '&#'+i.charCodeAt(0)+';';
//     });
// }

function getSlotAndName() {
    let s = '';
    let slot = parseInt(document.getElementById( "configurationSlot" ).value);
    if (slot >= 0) {
        s += `${(slot+1).toString().padStart(2, '0')}`;
    }
    let name = document.getElementById( "config_name" ).value;
    if (name != '') {
        if (s !== ''){
            s += ` - ${name}`;
        } else {
            s = name;
        }
    }
    return s;
}

function importData() {
    // let patch = prompt("z");
    let patch = window.location.hash.substr(1);
    // let params = new URLSearchParams(window.location.search);
    // let patch = params.get('patch');
    if (patch === '') return;
    let str = decompressFromEncodedURIComponent(patch);
    if (str === '' || str === null) return;
    const a = Uint8Array.from(str, c => c.charCodeAt(0))
    onMIDIMessage({data:a});
}

function exportData() {
    let str = Uint8ArrayToString(makeSysEx());
    let patch = compressToEncodedURIComponent(str);
    // let params = new URLSearchParams(window.location.search);
    // params.set('patch', patch);
    // window.location.search = params;
    window.location.hash = '#' + patch;
    // let configName = document.getElementById( "config_name" ).value;
    let s = getSlotAndName();
    if (s !== '') {
        document.title = "FH-2 Configuration Tool - " + s;  // assigning to document.title automatically escape the value.
    }
}

function updateData() {
    if (window.location.hash.length > 1) exportData();
}

function clearData() {
    window.location.hash = '';
    //history.pushState("", document.title, window.location.pathname + window.location.search);
}

function importFile(file) {
    const reader = new FileReader();
    reader.addEventListener('load', (event) => {
        const data = event.target.result;
        const a = new Uint8Array(data);
        onMIDIMessage({data:a});
    });
    reader.addEventListener('loadend', (event) => {
        updateData();
    });
    reader.readAsArrayBuffer(file);
}

const fileSelector = document.getElementById('file-selector');
fileSelector.addEventListener('change', (event) => {
    const fileList = event.target.files;
    importFile(fileList[0]);
});

const downloadToFile = (content, filename, contentType) => {
    const a = document.createElement('a');
    a.href= URL.createObjectURL(new Blob([content], {type: contentType}));
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
};

function exportFile() {
    let data = makeSysEx();
    // var data = new Uint8Array( str.length );
    // for ( var i=0; i<str.length; ++i ) {
    //     data[i] = str.charCodeAt( i );
    // }
    let filename = 'FH-2';
    // let slot = parseInt(document.getElementById( "configurationSlot" ).value);
    // if (slot >= 0) {
    //     filename += `_${slot.toString().padStart(2, '0')}`;
    // }
    // let name = document.getElementById( "config_name" ).value;
    // if (name != '') {
    //     filename += `_${name}`;
    // }
    let s = getSlotAndName();
    if (s !== '') {
        filename += " - " + s.replaceAll("/", "_");
    }
    downloadToFile(data, `${filename.trim()}.syx`, 'application/octet-stream');
}

//-----------------------------------------------------------------------------
// Configuration browser

async function loadConfiguration(onlyName = false) {
    let slot = parseInt(document.getElementById("configurationSlot").value);
    console.log("loadConfiguration :: slot", slot)
    if (slot < 0) return;
    let channel = parseInt(document.getElementById("configurationChannelSelector").value);
    var output = midi.outputs.get(document.getElementById("midioutput").value);
    var arr = [0xC0 + (0x0F & channel), 0x7F & slot];
    console.log("send", arr)
    output.send(arr);
    console.log("wait 50")
    await wait(50)
    if (onlyName) {
        requestConfigurationName();
    } else {
        var dd = log("send PC " + slot + " to FH-2");
        dumpSysex(arr, "txSysex", dd + "\n");
        request();
    }
}

function updateConfigurationSelector(name) {
    let s = document.getElementById( "configurationSlot" );
    let slot = parseInt(s.value);
    if (slot < 0) return;
    for (const option of s.options) {
        if (option.value == slot) {
            option.label = (parseInt(option.value)+1) + " - " + name;
        }
    }
}

function selectPreviousConfiguration(onlyName=false) {
    let slot = parseInt(document.getElementById( "configurationSlot" ).value);
    slot = (slot <= 0 ? 29 : (slot - 1));
    document.getElementById( "configurationSlot" ).value = slot;
    loadConfiguration(onlyName);
}

async function selectNextConfiguration(onlyName=false) {
    let slot = parseInt(document.getElementById( "configurationSlot" ).value);
    slot = (slot === 29 ? 0 : (slot + 1));
    console.log("selectNextConfiguration :: set slot", slot)
    document.getElementById( "configurationSlot" ).value = slot;
    await loadConfiguration(onlyName);
}

async function scanConfiguration() {
    var currentSlot = document.getElementById( "configurationSlot" ).value;
    // console.log("save slot", currentSlot)
    // console.log("scan: current slot is", currentSlot);
    document.getElementById( "configurationSlot" ).value = 0;
    await loadConfiguration(true);
    // TODO: wait until message received, like below; and remove the wait(200)
    // console.log("wait 200")
    await wait(200);
    for (let i=0; i<30; i++) {
        // The DFH-2 replies very fast, so a very small interval between the requests is possible.
        //  but the web application is slow, so the delay must be increased.
        // window.setTimeout(() => selectNextConfiguration(true), (i+1) * 200);

        // console.log("set last_received_message = RECEIVED_NONE")
        last_received_message = RECEIVED_NONE;

        await selectNextConfiguration(true);
        // console.log("wait 200 (selectNextConfiguration done)")
        // await wait(200);
        let retries = 40;
        while (retries > 0 && last_received_message !== RECEIVED_CONFIG_NAME) {
            await wait(20);
            retries--;
            // console.log("retry", retries);
        }
        // console.log("last_received_message", last_received_message)
        // console.log("retries", retries)
        await wait(50)
    }

    // console.log("wait 200")
    // await wait(200);
    // console.log("reset slot", currentSlot)
    document.getElementById( "configurationSlot" ).value = currentSlot;

    // after the scan, reset the configuration selector to the value it had before the scan:
    // window.setTimeout(() => {
    //     // console.log("scan: done; reset selector to", currentSlot);
    //     document.getElementById( "configurationSlot" ).value = currentSlot;
    // }, 32 * 300);
}

//-----------------------------------------------------------------------------
// Utilities :

function Uint8ArrayToString(arr) {
    var str = "";
	for (var i = 0; i < arr.length; ++i) {
		str += String.fromCharCode(arr[i]);
	}
	return str;
}

function stringToUint8Array(str) {
    var arr = new Uint8Array(str.length);
	for (var i = 0; i < str.length; ++i) {
		arr[i] = str.charCodeAt( i );
	}
    return arr;
}

//-----------------------------------------------------------------------------
// Custom init :

function ready(fn) {
    if (document.readyState !== 'loading') {
        fn();
    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}

function check(id) {
    let e = document.getElementById(id);
    if (e) e.checked = true;
}

ready(function() {
    // custom init
    // console.log("start init");

    var t = localStorage.getItem( themeKey ) || "light";
    if (t) {
        // document.getElementById( "theme" ).value = t;
        changeTheme(t);
    }

    check("show8cvoutputs0");
    check("show8cvoutputs1");
    check("show8cvoutputs2");
    showHide("outs0_table", true);
    showHide("outs1_table", true);
    showHide("outs2_table", true);
    showHide("clk_table", true);
    showHide("seq_table", true);
    showHide("env_table", true);

    console.log("set midi in and out");

    fh2InPortId = localStorage.getItem(fh2MIDIInKey);
    fh2OutPortId = localStorage.getItem(fh2MIDIOutKey);
    if (fh2InPortId) {
        setMidiInSelect(fh2InPortId);
    }
    if (fh2OutPortId) {
        setMidiOutSelect(fh2OutPortId);
    }

    console.log("import patch from url");
    importData();

    console.log("done. ready for usage.");
});

    var keyStrBase64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    var keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
    var baseReverseDic = {};

    function getBaseValue(alphabet, character) {
        if (!baseReverseDic[alphabet]) {
            baseReverseDic[alphabet] = {};
            for (var i=0 ; i<alphabet.length ; i++) {
                baseReverseDic[alphabet][alphabet.charAt(i)] = i;
            }
        }
        return baseReverseDic[alphabet][character];
    }

    function compress(uncompressed, bitsPerChar, getCharFromInt) {
        if (uncompressed == null) return "";
        var i, value,
            context_dictionary= {},
            context_dictionaryToCreate= {},
            context_c="",
            context_wc="",
            context_w="",
            context_enlargeIn= 2, // Compensate for the first entry which should not count
            context_dictSize= 3,
            context_numBits= 2,
            context_data=[],
            context_data_val=0,
            context_data_position=0,
            ii;

        for (ii = 0; ii < uncompressed.length; ii += 1) {
            context_c = uncompressed.charAt(ii);
            if (!Object.prototype.hasOwnProperty.call(context_dictionary,context_c)) {
                context_dictionary[context_c] = context_dictSize++;
                context_dictionaryToCreate[context_c] = true;
            }

            context_wc = context_w + context_c;
            if (Object.prototype.hasOwnProperty.call(context_dictionary,context_wc)) {
                context_w = context_wc;
            } else {
                if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)) {
                    if (context_w.charCodeAt(0)<256) {
                        for (i=0 ; i<context_numBits ; i++) {
                            context_data_val = (context_data_val << 1);
                            if (context_data_position == bitsPerChar-1) {
                                context_data_position = 0;
                                context_data.push(getCharFromInt(context_data_val));
                                context_data_val = 0;
                            } else {
                                context_data_position++;
                            }
                        }
                        value = context_w.charCodeAt(0);
                        for (i=0 ; i<8 ; i++) {
                            context_data_val = (context_data_val << 1) | (value&1);
                            if (context_data_position == bitsPerChar-1) {
                                context_data_position = 0;
                                context_data.push(getCharFromInt(context_data_val));
                                context_data_val = 0;
                            } else {
                                context_data_position++;
                            }
                            value = value >> 1;
                        }
                    } else {
                        value = 1;
                        for (i=0 ; i<context_numBits ; i++) {
                            context_data_val = (context_data_val << 1) | value;
                            if (context_data_position ==bitsPerChar-1) {
                                context_data_position = 0;
                                context_data.push(getCharFromInt(context_data_val));
                                context_data_val = 0;
                            } else {
                                context_data_position++;
                            }
                            value = 0;
                        }
                        value = context_w.charCodeAt(0);
                        for (i=0 ; i<16 ; i++) {
                            context_data_val = (context_data_val << 1) | (value&1);
                            if (context_data_position == bitsPerChar-1) {
                                context_data_position = 0;
                                context_data.push(getCharFromInt(context_data_val));
                                context_data_val = 0;
                            } else {
                                context_data_position++;
                            }
                            value = value >> 1;
                        }
                    }
                    context_enlargeIn--;
                    if (context_enlargeIn == 0) {
                        context_enlargeIn = Math.pow(2, context_numBits);
                        context_numBits++;
                    }
                    delete context_dictionaryToCreate[context_w];
                } else {
                    value = context_dictionary[context_w];
                    for (i=0 ; i<context_numBits ; i++) {
                        context_data_val = (context_data_val << 1) | (value&1);
                        if (context_data_position == bitsPerChar-1) {
                            context_data_position = 0;
                            context_data.push(getCharFromInt(context_data_val));
                            context_data_val = 0;
                        } else {
                            context_data_position++;
                        }
                        value = value >> 1;
                    }


                }
                context_enlargeIn--;
                if (context_enlargeIn == 0) {
                    context_enlargeIn = Math.pow(2, context_numBits);
                    context_numBits++;
                }
                // Add wc to the dictionary.
                context_dictionary[context_wc] = context_dictSize++;
                context_w = String(context_c);
            }
        }

        // Output the code for w.
        if (context_w !== "") {
            if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)) {
                if (context_w.charCodeAt(0)<256) {
                    for (i=0 ; i<context_numBits ; i++) {
                        context_data_val = (context_data_val << 1);
                        if (context_data_position == bitsPerChar-1) {
                            context_data_position = 0;
                            context_data.push(getCharFromInt(context_data_val));
                            context_data_val = 0;
                        } else {
                            context_data_position++;
                        }
                    }
                    value = context_w.charCodeAt(0);
                    for (i=0 ; i<8 ; i++) {
                        context_data_val = (context_data_val << 1) | (value&1);
                        if (context_data_position == bitsPerChar-1) {
                            context_data_position = 0;
                            context_data.push(getCharFromInt(context_data_val));
                            context_data_val = 0;
                        } else {
                            context_data_position++;
                        }
                        value = value >> 1;
                    }
                } else {
                    value = 1;
                    for (i=0 ; i<context_numBits ; i++) {
                        context_data_val = (context_data_val << 1) | value;
                        if (context_data_position == bitsPerChar-1) {
                            context_data_position = 0;
                            context_data.push(getCharFromInt(context_data_val));
                            context_data_val = 0;
                        } else {
                            context_data_position++;
                        }
                        value = 0;
                    }
                    value = context_w.charCodeAt(0);
                    for (i=0 ; i<16 ; i++) {
                        context_data_val = (context_data_val << 1) | (value&1);
                        if (context_data_position == bitsPerChar-1) {
                            context_data_position = 0;
                            context_data.push(getCharFromInt(context_data_val));
                            context_data_val = 0;
                        } else {
                            context_data_position++;
                        }
                        value = value >> 1;
                    }
                }
                context_enlargeIn--;
                if (context_enlargeIn == 0) {
                    context_enlargeIn = Math.pow(2, context_numBits);
                    context_numBits++;
                }
                delete context_dictionaryToCreate[context_w];
            } else {
                value = context_dictionary[context_w];
                for (i=0 ; i<context_numBits ; i++) {
                    context_data_val = (context_data_val << 1) | (value&1);
                    if (context_data_position == bitsPerChar-1) {
                        context_data_position = 0;
                        context_data.push(getCharFromInt(context_data_val));
                        context_data_val = 0;
                    } else {
                        context_data_position++;
                    }
                    value = value >> 1;
                }


            }
            context_enlargeIn--;
            if (context_enlargeIn == 0) {
                context_enlargeIn = Math.pow(2, context_numBits);
                context_numBits++;
            }
        }

        // Mark the end of the stream
        value = 2;
        for (i=0 ; i<context_numBits ; i++) {
            context_data_val = (context_data_val << 1) | (value&1);
            if (context_data_position == bitsPerChar-1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
            } else {
                context_data_position++;
            }
            value = value >> 1;
        }

        // Flush the last char
        while (true) {
            context_data_val = (context_data_val << 1);
            if (context_data_position == bitsPerChar-1) {
                context_data.push(getCharFromInt(context_data_val));
                break;
            }
            else context_data_position++;
        }
        return context_data.join('');
    }

    function decompress(length, resetValue, getNextValue) {
        var dictionary = [],
            next,
            enlargeIn = 4,
            dictSize = 4,
            numBits = 3,
            entry = "",
            result = [],
            i,
            w,
            bits, resb, maxpower, power,
            c,
            data = {val:getNextValue(0), position:resetValue, index:1};

        for (i = 0; i < 3; i += 1) {
            dictionary[i] = i;
        }

        bits = 0;
        maxpower = Math.pow(2,2);
        power=1;
        while (power!=maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) {
                data.position = resetValue;
                data.val = getNextValue(data.index++);
            }
            bits |= (resb>0 ? 1 : 0) * power;
            power <<= 1;
        }

        switch (next = bits) {
            case 0:
                bits = 0;
                maxpower = Math.pow(2,8);
                power=1;
                while (power!=maxpower) {
                    resb = data.val & data.position;
                    data.position >>= 1;
                    if (data.position == 0) {
                        data.position = resetValue;
                        data.val = getNextValue(data.index++);
                    }
                    bits |= (resb>0 ? 1 : 0) * power;
                    power <<= 1;
                }
                c = String.fromCharCode(bits);
                break;
            case 1:
                bits = 0;
                maxpower = Math.pow(2,16);
                power=1;
                while (power!=maxpower) {
                    resb = data.val & data.position;
                    data.position >>= 1;
                    if (data.position == 0) {
                        data.position = resetValue;
                        data.val = getNextValue(data.index++);
                    }
                    bits |= (resb>0 ? 1 : 0) * power;
                    power <<= 1;
                }
                c = String.fromCharCode(bits);
                break;
            case 2:
                return "";
        }
        dictionary[3] = c;
        w = c;
        result.push(c);
        while (true) {
            if (data.index > length) {
                return "";
            }

            bits = 0;
            maxpower = Math.pow(2,numBits);
            power=1;
            while (power!=maxpower) {
                resb = data.val & data.position;
                data.position >>= 1;
                if (data.position == 0) {
                    data.position = resetValue;
                    data.val = getNextValue(data.index++);
                }
                bits |= (resb>0 ? 1 : 0) * power;
                power <<= 1;
            }

            switch (c = bits) {
                case 0:
                    bits = 0;
                    maxpower = Math.pow(2,8);
                    power=1;
                    while (power!=maxpower) {
                        resb = data.val & data.position;
                        data.position >>= 1;
                        if (data.position == 0) {
                            data.position = resetValue;
                            data.val = getNextValue(data.index++);
                        }
                        bits |= (resb>0 ? 1 : 0) * power;
                        power <<= 1;
                    }

                    dictionary[dictSize++] = String.fromCharCode(bits);
                    c = dictSize-1;
                    enlargeIn--;
                    break;
                case 1:
                    bits = 0;
                    maxpower = Math.pow(2,16);
                    power=1;
                    while (power!=maxpower) {
                        resb = data.val & data.position;
                        data.position >>= 1;
                        if (data.position == 0) {
                            data.position = resetValue;
                            data.val = getNextValue(data.index++);
                        }
                        bits |= (resb>0 ? 1 : 0) * power;
                        power <<= 1;
                    }
                    dictionary[dictSize++] = String.fromCharCode(bits);
                    c = dictSize-1;
                    enlargeIn--;
                    break;
                case 2:
                    return result.join('');
            }

            if (enlargeIn == 0) {
                enlargeIn = Math.pow(2, numBits);
                numBits++;
            }

            if (dictionary[c]) {
                entry = dictionary[c];
            } else {
                if (c === dictSize) {
                    entry = w + w.charAt(0);
                } else {
                    return null;
                }
            }
            result.push(entry);

            // Add w+entry[0] to the dictionary.
            dictionary[dictSize++] = w + entry.charAt(0);
            enlargeIn--;

            w = entry;

            if (enlargeIn == 0) {
                enlargeIn = Math.pow(2, numBits);
                numBits++;
            }

        }
    }

    function compressToEncodedURIComponent(input) {
        if (input == null) return "";
        return compress(input, 6, function(a){
            return keyStrUriSafe.charAt(a);
        });
    }

    //decompress from an output of compressToEncodedURIComponent
    function decompressFromEncodedURIComponent(input) {
        if (input == null) return "";
        if (input == "") return null;
        input = input.replace(/ /g, "+");
        return decompress(input.length, 32, function(index) {
            return getBaseValue(keyStrUriSafe, input.charAt(index));
        });
    }


</script>

</body>
